<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Loonie Bird</title>
    
    <!-- PWA & iOS App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loonie Bird">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d9488">
    <meta name="description" content="Music lesson scheduling app for teachers">
    
    <!-- App Icon (180x180 for iOS) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230d9488'/><circle cx='90' cy='85' r='50' fill='%23fbbf24'/><ellipse cx='90' cy='95' rx='35' ry='25' fill='%23f59e0b'/><circle cx='75' cy='75' r='8' fill='%231c1917'/><circle cx='105' cy='75' r='8' fill='%231c1917'/><path d='M80 100 Q90 115 100 100' stroke='%231c1917' stroke-width='4' fill='none' stroke-linecap='round'/><path d='M55 55 Q45 35 60 40' stroke='%23fbbf24' stroke-width='6' fill='none' stroke-linecap='round'/><path d='M125 55 Q135 35 120 40' stroke='%23fbbf24' stroke-width='6' fill='none' stroke-linecap='round'/><text x='90' y='155' text-anchor='middle' font-family='system-ui' font-size='24' font-weight='bold' fill='white'>♪</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230d9488'/><circle cx='16' cy='14' r='9' fill='%23fbbf24'/><circle cx='13' cy='12' r='2' fill='%231c1917'/><circle cx='19' cy='12' r='2' fill='%231c1917'/><text x='16' y='28' text-anchor='middle' font-size='10' fill='white'>♪</text></svg>">
    
    <!-- Web App Manifest (inline) -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22Loonie%20Bird%22,%22short_name%22:%22Loonie%20Bird%22,%22description%22:%22Music%20lesson%20scheduling%20app%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23fafaf9%22,%22theme_color%22:%22%230d9488%22}">
    
    <!-- Splash Screens for iOS -->
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300..900;1,9..144,300..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Primary palette - warm amber/gold */
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-200: #fde68a;
            --amber-300: #fcd34d;
            --amber-400: #fbbf24;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --amber-700: #b45309;
            
            /* Secondary palette - deep teal */
            --teal-50: #f0fdfa;
            --teal-100: #ccfbf1;
            --teal-200: #99f6e4;
            --teal-500: #14b8a6;
            --teal-600: #0d9488;
            --teal-700: #0f766e;
            --teal-800: #115e59;
            --teal-900: #134e4a;
            
            /* Neutrals - warm gray */
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            
            /* Accent colors */
            --coral-500: #f97316;
            --rose-500: #f43f5e;
            --rose-600: #e11d48;
            --violet-50: #f5f3ff;
            --violet-100: #ede9fe;
            --violet-300: #c4b5fd;
            --violet-500: #8b5cf6;
            --violet-700: #6d28d9;
            --emerald-500: #10b981;
            --sky-500: #0ea5e9;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.15);
            
            /* Typography */
            --font-display: 'Fraunces', Georgia, serif;
            --font-body: 'DM Sans', system-ui, sans-serif;
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --stone-50: #1c1917;
            --stone-100: #292524;
            --stone-200: #44403c;
            --stone-300: #57534e;
            --stone-400: #78716c;
            --stone-500: #a8a29e;
            --stone-600: #d6d3d1;
            --stone-700: #e7e5e4;
            --stone-800: #f5f5f4;
            --stone-900: #fafaf9;
            
            --amber-50: #292524;
            --amber-100: #44403c;
            
            --teal-50: #1c1917;
            --teal-100: #292524;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.3);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.3);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.1);
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
        }
        
        [data-theme="dark"] .login-card,
        [data-theme="dark"] .calendar-wrapper,
        [data-theme="dark"] .app-header {
            background: #292524;
            border-color: #44403c;
        }
        
        [data-theme="dark"] #loginScreen {
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #1c1917 0%, #292524 100%);
        }
        
        [data-theme="dark"] .calendar-table thead th {
            background: #1c1917;
            border-color: #44403c;
        }
        
        [data-theme="dark"] .calendar-table th:first-child {
            background: #0f0e0d;
        }
        
        [data-theme="dark"] .calendar-table th.today-header {
            background: linear-gradient(135deg, var(--teal-700) 0%, var(--teal-800) 100%);
        }
        
        [data-theme="dark"] .calendar-table td {
            border-color: #44403c;
            background: #292524;
        }
        
        [data-theme="dark"] .calendar-table td:first-child {
            background: #1c1917;
        }
        
        [data-theme="dark"] .calendar-table td.past-day {
            background: #1c1917;
        }
        
        [data-theme="dark"] .lesson-slot {
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .modal-content {
            background: #292524;
            color: #f5f5f4;
        }
        
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .login-input {
            background: #1c1917;
            border-color: #44403c;
            color: #f5f5f4;
        }
        
        [data-theme="dark"] .info-box {
            background: #1c1917;
        }
        
        [data-theme="dark"] .student-card {
            background: #1c1917;
            border-color: #44403c;
        }
        
        [data-theme="dark"] .btn-nav {
            background: #1c1917;
            border-color: #44403c;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .btn-nav:hover {
            background: #44403c;
        }
        
        [data-theme="dark"] .logout-btn {
            background: #1c1917;
            border-color: #44403c;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .user-badge {
            background: #1c1917;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .photo-placeholder {
            background: #1c1917;
            border-color: #44403c;
            color: #78716c;
        }
        
        [data-theme="dark"] .photo-preview-img {
            border-color: var(--teal-700);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            padding: 0.5rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
        }
        
        .theme-toggle:hover {
            background: var(--stone-200);
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--stone-800);
            background: linear-gradient(135deg, var(--stone-100) 0%, var(--amber-50) 100%);
            min-height: 100vh;
            /* iOS safe areas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in specific areas */
        .modal-content, .info-box, input, textarea, .detail-value {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* PWA standalone mode adjustments */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            .app-header {
                padding-top: calc(1rem + env(safe-area-inset-top));
            }
        }
        
        /* Typography */
        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        /* ===== LOGIN SCREEN ===== */
        #loginScreen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--stone-100) 0%, var(--amber-50) 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl), var(--shadow-glow);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--amber-400), var(--teal-500), var(--amber-400));
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .login-logo .bird-icon {
            font-size: 4rem;
            display: block;
            margin-bottom: 0.5rem;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .login-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--teal-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }
        
        .login-logo p {
            color: var(--stone-500);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .login-btn-primary {
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-700) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(13, 148, 136, 0.3);
        }
        
        .login-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.4);
        }
        
        .login-btn-secondary {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }
        
        .login-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .login-divider {
            display: flex;
            align-items: center;
            margin: 1.75rem 0;
            gap: 1rem;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--stone-300), transparent);
        }
        
        .login-divider span {
            color: var(--stone-400);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .login-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--amber-400);
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1);
        }
        
        .login-input::placeholder {
            text-transform: none;
            letter-spacing: normal;
        }
        
        .login-help {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--stone-200);
        }
        
        .login-help p {
            color: var(--stone-500);
            font-size: 0.875rem;
        }
        
        /* ===== MAIN APP LAYOUT ===== */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        #mainApp.active {
            display: flex;
        }
        
        /* ===== HEADER ===== */
        .app-header {
            background: white;
            border-bottom: 1px solid var(--stone-200);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-brand .bird-icon {
            font-size: 2rem;
        }
        
        .header-brand h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--teal-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--stone-100);
            border-radius: 100px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-700);
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: var(--stone-200);
            color: var(--stone-800);
        }
        
        /* ===== CONTROL BAR ===== */
        .control-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-height: 44px; /* iOS touch target minimum */
            touch-action: manipulation;
        }
        
        /* Touch-friendly tap states */
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--emerald-500) 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }
        
        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }
        
        .btn-block {
            background: linear-gradient(135deg, var(--coral-500) 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.25);
        }
        
        .btn-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.35);
        }
        
        .btn-students {
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);
        }
        
        .btn-students:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.35);
        }
        
        .btn-swaps {
            background: linear-gradient(135deg, var(--sky-500) 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.25);
            position: relative;
        }
        
        .btn-swaps:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.35);
        }
        
        .btn-payments {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.25);
        }
        
        .btn-payments:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
        }
        
        .btn-swaps .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--rose-500);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(244, 63, 94, 0.4);
        }
        
        .btn-swap {
            padding: 1rem 2rem;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
            position: relative;
        }
        
        .btn-swap:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        
        .btn-swap .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--rose-500);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(244, 63, 94, 0.4);
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .btn-nav {
            padding: 0.625rem 1rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-700);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-nav:hover {
            background: var(--stone-200);
            border-color: var(--stone-300);
        }
        
        .btn-today {
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.25);
        }
        
        .btn-today:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.35);
        }
        
        /* ===== CALENDAR ===== */
        .calendar-container {
            flex: 1;
            padding: 1.5rem;
            overflow: hidden;
        }
        
        .calendar-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            position: relative;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }
        
        .calendar-table th:first-child,
        .calendar-table td:first-child {
            width: 80px;
        }
        
        .calendar-table th:not(:first-child),
        .calendar-table td:not(:first-child) {
            width: calc((100% - 80px) / 7);
        }
        
        .calendar-table thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--stone-800);
            color: white;
            padding: 1rem 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            border-bottom: 2px solid var(--stone-600);
        }
        
        .calendar-table th:first-child {
            background: var(--stone-900);
            z-index: 21;
        }
        
        .calendar-table th.today-header {
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-700) 100%);
        }
        
        .calendar-table th.past-header {
            background: var(--stone-600);
            color: var(--stone-400);
        }
        
        .day-name {
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .day-date {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .calendar-table td {
            border: 1px solid var(--stone-200);
            vertical-align: top;
            height: 80px;
            position: relative;
            transition: background 0.15s ease;
        }
        
        .calendar-table td:first-child {
            background: var(--stone-50);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--stone-600);
            text-align: center;
            vertical-align: middle;
            border-left: none;
        }
        
        .calendar-table td.past-day {
            background: var(--stone-100);
            opacity: 0.6;
        }
        
        .calendar-table td.drop-zone:hover:not(.past-day) {
            background: var(--amber-50);
        }
        
        /* ===== LESSON SLOTS ===== */
        .lesson-slot {
            position: absolute;
            left: 3px;
            right: 3px;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: move;
            overflow: hidden;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            z-index: 1;
        }
        
        .lesson-slot:hover {
            transform: scale(1.02);
            z-index: 5;
        }
        
        .lesson-slot.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        
        .lesson-slot .student-name {
            font-weight: 700;
            font-size: 0.75rem;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lesson-30 { height: 40px; }
        .lesson-45 { height: 60px; }
        .lesson-60 { height: 80px; }
        
        /* Lesson color variants */
        .lesson-overlap-0 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #60a5fa;
            color: #1e40af;
        }
        
        .lesson-overlap-1 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            color: #92400e;
        }
        
        .lesson-overlap-2 {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #34d399;
            color: #065f46;
        }
        
        .lesson-overlap-3 {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 2px solid #a78bfa;
            color: #5b21b6;
        }
        
        .lesson-overlap-4 {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #f472b6;
            color: #9d174d;
        }
        
        .lesson-overlap-5 {
            background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            border: 2px solid #fb923c;
            color: #9a3412;
        }
        
        /* Student's own lessons - golden highlight */
        .my-lesson {
            background: linear-gradient(135deg, var(--amber-200) 0%, var(--amber-300) 100%);
            border: 2px solid var(--amber-500);
            color: var(--amber-900);
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }
        
        .my-lesson:hover {
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* ===== BLOCKED SLOTS ===== */
        .blocked-slot {
            position: absolute;
            left: 3px;
            right: 3px;
            z-index: 10;
            background: repeating-linear-gradient(
                45deg,
                var(--stone-300),
                var(--stone-300) 8px,
                var(--stone-400) 8px,
                var(--stone-400) 16px
            );
            color: var(--stone-700);
            padding: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            box-sizing: border-box;
        }
        
        .blocked-slot:hover {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-400),
                var(--stone-400) 8px,
                var(--stone-500) 8px,
                var(--stone-500) 16px
            );
        }
        
        [data-theme="dark"] .blocked-slot {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-600),
                var(--stone-600) 8px,
                var(--stone-700) 8px,
                var(--stone-700) 16px
            );
            color: var(--stone-400);
            border-color: var(--stone-600);
        }
        
        [data-theme="dark"] .blocked-slot:hover {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-500),
                var(--stone-500) 8px,
                var(--stone-600) 8px,
                var(--stone-600) 16px
            );
        }
        
        /* ===== MODAL ===== */
        #modal {
            position: fixed;
            inset: 0;
            background: rgba(28, 25, 23, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }
        
        #modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #modalContent {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            animation: slideUp 0.25s ease;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 1.5rem;
        }
        
        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--stone-500);
            margin-top: -1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--stone-700);
            margin-bottom: 0.5rem;
        }
        
        .form-label-optional {
            font-weight: 400;
            color: var(--stone-400);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.9375rem;
            color: var(--stone-800);
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--teal-500);
            box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
        }
        
        .form-input[readonly] {
            background: var(--stone-100);
            color: var(--stone-500);
            cursor: not-allowed;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--teal-600);
            cursor: pointer;
        }
        
        .form-checkbox span {
            font-size: 0.9rem;
            color: var(--stone-700);
        }
        
        .modal-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        
        .modal-btn:last-child {
            margin-bottom: 0;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(20, 184, 166, 0.3);
        }
        
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        }
        
        .modal-btn-success {
            background: linear-gradient(135deg, var(--emerald-500) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }
        
        .modal-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .modal-btn-warning {
            background: linear-gradient(135deg, var(--coral-500) 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(249, 115, 22, 0.3);
        }
        
        .modal-btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }
        
        .modal-btn-danger {
            background: linear-gradient(135deg, var(--rose-500) 0%, #e11d48 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(244, 63, 94, 0.3);
        }
        
        .modal-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.4);
        }
        
        .modal-btn-secondary {
            background: var(--stone-100);
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
        }
        
        .modal-btn-secondary:hover {
            background: var(--stone-200);
        }
        
        .modal-btn-violet {
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
        }
        
        .modal-btn-violet:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        
        /* Info boxes */
        .info-box {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .info-box-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid var(--amber-300);
            color: var(--amber-800);
        }
        
        .info-box-info {
            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
            border: 1px solid var(--sky-500);
            color: #075985;
        }
        
        .info-box-success {
            background: linear-gradient(135deg, #d1fae5 0%, #dcfce7 100%);
            border: 1px solid var(--emerald-500);
            color: #065f46;
        }
        
        .info-box-danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid var(--rose-500);
            color: #9f1239;
        }
        
        /* Detail cards */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--stone-100);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--stone-500);
            font-size: 0.875rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--stone-800);
            font-size: 0.875rem;
        }
        
        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, var(--teal-100) 0%, var(--teal-50) 100%);
            border: 1px solid var(--teal-300);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--teal-700);
            margin-top: 0.5rem;
        }
        
        /* Student list cards */
        .student-card {
            padding: 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease;
        }
        
        .student-card:hover {
            border-color: var(--teal-400);
            background: var(--teal-50);
        }
        
        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-name-large {
            font-weight: 700;
            font-size: 1rem;
            color: var(--stone-800);
        }
        
        .student-meta {
            font-size: 0.8rem;
            color: var(--stone-500);
            margin-top: 0.25rem;
        }
        
        .student-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }
        
        /* Profile section */
        .profile-section {
            background: linear-gradient(135deg, var(--teal-50) 0%, var(--amber-50) 100%);
            border: 1px solid var(--teal-200);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .profile-header {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: var(--stone-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--stone-400);
            font-size: 0.75rem;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        /* Photo Upload Styles */
        .photo-upload-section {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .photo-upload-preview {
            position: relative;
            flex-shrink: 0;
        }
        
        .photo-preview-img {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--teal-200);
            box-shadow: var(--shadow-md);
        }
        
        .photo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            background: var(--stone-100);
            border: 2px dashed var(--stone-300);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--stone-400);
            font-size: 1.5rem;
        }
        
        .photo-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--rose-500);
            color: white;
            border: 2px solid white;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        .photo-remove-btn:hover {
            background: var(--rose-600);
            transform: scale(1.1);
        }
        
        .photo-upload-controls {
            flex: 1;
            min-width: 0;
        }
        
        .family-code-display {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            background: linear-gradient(135deg, var(--violet-100) 0%, var(--violet-50) 100%);
            border: 1px solid var(--violet-300);
            border-radius: 6px;
            font-family: monospace;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--violet-700);
            letter-spacing: 0.05em;
        }
        
        /* Swap request cards */
        .swap-request-card {
            background: white;
            border: 2px solid var(--amber-300);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .swap-arrow {
            text-align: center;
            color: var(--stone-400);
            font-size: 1.25rem;
            margin: 0.5rem 0;
        }
        
        /* Toast notification */
        #toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--stone-800) 0%, var(--stone-900) 100%);
            color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            font-weight: 500;
            z-index: 2000;
            display: none;
            animation: slideInRight 0.3s ease;
        }
        
        #toast.show {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Section dividers */
        .section-divider {
            border-top: 2px solid var(--stone-200);
            margin: 1.5rem 0;
            padding-top: 1.5rem;
        }
        
        .section-title {
            font-family: var(--font-display);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--stone-400);
            margin-bottom: 1rem;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--stone-100);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--stone-300);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--stone-400);
        }
        
        /* Conflict list */
        .conflict-list {
            background: var(--amber-50);
            border: 1px solid var(--amber-200);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .conflict-item {
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--amber-200);
        }
        
        .conflict-item:last-child {
            border-bottom: none;
        }
        
        /* Lesson list for student view */
        .lesson-list-item {
            background: linear-gradient(135deg, var(--amber-50) 0%, var(--amber-100) 100%);
            border: 2px solid var(--amber-300);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .lesson-list-item:hover {
            border-color: var(--amber-500);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .lesson-list-time {
            font-weight: 700;
            font-size: 1rem;
            color: var(--stone-800);
        }
        
        .lesson-list-duration {
            font-size: 0.8rem;
            color: var(--stone-500);
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        /* Max height scroll containers */
        .scroll-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Payment tracking styles */
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .payment-stat {
            text-align: center;
            padding: 1rem;
            border-radius: 12px;
            background: var(--stone-100);
        }
        
        .payment-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-display);
        }
        
        .payment-stat-label {
            font-size: 0.75rem;
            color: var(--stone-500);
            margin-top: 0.25rem;
        }
        
        .payment-stat.paid {
            background: rgba(16, 185, 129, 0.15);
        }
        
        .payment-stat.paid .payment-stat-value {
            color: var(--emerald-500);
        }
        
        .payment-stat.unpaid {
            background: rgba(244, 63, 94, 0.15);
        }
        
        .payment-stat.unpaid .payment-stat-value {
            color: var(--rose-500);
        }
        
        .payment-stat.total {
            background: rgba(139, 92, 246, 0.15);
        }
        
        .payment-stat.total .payment-stat-value {
            color: var(--violet-500);
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--stone-200);
        }
        
        .payment-row:last-child {
            border-bottom: none;
        }
        
        .payment-row-info {
            flex: 1;
        }
        
        .payment-row-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .payment-row-detail {
            font-size: 0.75rem;
            color: var(--stone-500);
        }
        
        .payment-row-amount {
            font-weight: 700;
            font-family: var(--font-display);
            font-size: 1rem;
            margin-right: 0.75rem;
        }
        
        .payment-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .payment-badge.paid {
            background: var(--emerald-500);
            color: white;
        }
        
        .payment-badge.unpaid {
            background: var(--rose-500);
            color: white;
        }
        
        .rate-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .rate-input input {
            width: 100px;
            text-align: right;
        }
        
        .invoice-preview {
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }
        
        [data-theme="dark"] .invoice-preview {
            background: #1c1917;
            border-color: #44403c;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--stone-200);
        }
        
        .invoice-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .invoice-table th,
        .invoice-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--stone-200);
        }
        
        .invoice-table th {
            font-weight: 600;
            background: var(--stone-100);
        }
        
        .invoice-total {
            text-align: right;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--stone-300);
        }
        
        /* Data persistence indicator */
        .save-indicator {
            font-size: 0.75rem;
            color: var(--stone-400);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .save-indicator.saving {
            color: var(--amber-500);
        }
        
        .save-indicator.saved {
            color: var(--emerald-500);
        }
        
        /* iOS Splash/Loading Screen */
        #splashScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-800) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        #splashScreen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .splash-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: splash-bounce 1s ease infinite;
        }
        
        .splash-title {
            font-family: var(--font-display);
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .splash-subtitle {
            color: var(--teal-200);
            font-size: 1rem;
        }
        
        .splash-loader {
            margin-top: 2rem;
            width: 40px;
            height: 40px;
            border: 3px solid var(--teal-400);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes splash-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- iOS Splash Screen -->
    <div id="splashScreen">
        <div class="splash-icon">🐦</div>
        <div class="splash-title">Loonie Bird</div>
        <div class="splash-subtitle">Music Lesson Scheduler</div>
        <div class="splash-loader"></div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <span class="bird-icon">🐦</span>
                <h1>Loonie Bird</h1>
                <p>Music Lesson Scheduler</p>
            </div>
            
            <button onclick="loginAsTeacher()" class="login-btn login-btn-primary">
                <span>👨‍🏫</span> Teacher Login
            </button>
            
            <div class="login-divider">
                <span>or student access</span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Family Code</label>
                <input 
                    type="text" 
                    id="familyCodeInput" 
                    placeholder="Enter your code" 
                    class="login-input"
                    onkeypress="if(event.key==='Enter') loginAsStudent()"
                >
            </div>
            
            <button onclick="loginAsStudent()" class="login-btn login-btn-secondary">
                <span>🎓</span> Student Login
            </button>
            
            <div class="login-help">
                <p>Need a code? Contact your teacher</p>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                    <button onclick="toggleDarkMode()" class="theme-toggle" id="loginThemeToggle" title="Toggle dark mode">🌙</button>
                    <button onclick="clearAllData()" style="padding: 0.5rem 1rem; background: var(--stone-200); border: none; border-radius: 8px; font-size: 0.75rem; color: var(--stone-500); cursor: pointer;">Reset All Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp">
        <header class="app-header">
            <div class="header-content">
                <div class="header-top">
                    <div class="header-brand">
                        <span class="bird-icon">🐦</span>
                        <h1>Loonie Bird</h1>
                    </div>
                    <div class="header-user">
                        <span class="save-indicator" id="saveIndicator">💾 Saved</span>
                        <button onclick="toggleDarkMode()" class="theme-toggle" id="themeToggle" title="Toggle dark mode">🌙</button>
                        <div class="user-badge" id="loginStatus"></div>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
                
                <div id="teacherControls" class="control-bar">
                    <button onclick="showAddModal()" class="btn btn-add">
                        <span>+</span> Add Lesson
                    </button>
                    <button onclick="showBlockTimeModal()" class="btn btn-block">
                        <span>🚫</span> Block Time
                    </button>
                    <button onclick="showStudentsModal()" class="btn btn-students">
                        <span>👥</span> Students
                    </button>
                    <button onclick="showPaymentsModal()" class="btn btn-payments">
                        <span>💰</span> Payments
                    </button>
                    <button onclick="showTeacherSwapRequests()" class="btn btn-swaps" id="teacherSwapBtn">
                        <span>🔄</span> Swaps
                    </button>
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)" class="btn-nav">← Previous</button>
                        <button id="weekLabel" onclick="goToToday()" class="btn-nav btn-today">Today</button>
                        <button onclick="changeWeek(1)" class="btn-nav">Next →</button>
                    </div>
                </div>
                
                <div id="studentControls" class="control-bar hidden">
                    <button onclick="showMyLessonsForSwap()" class="btn btn-swap">
                        <span>🔄</span> Request Swap
                        <span id="mySwapBadge" class="badge hidden">0</span>
                    </button>
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)" class="btn-nav">← Previous</button>
                        <button id="weekLabel2" onclick="goToToday()" class="btn-nav btn-today">Today</button>
                        <button onclick="changeWeek(1)" class="btn-nav">Next →</button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="calendar-container">
            <div class="calendar-wrapper">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal">
        <div id="modalContent"></div>
    </div>
    
    <!-- Toast -->
    <div id="toast"></div>

<script>
// ===== DATA PERSISTENCE =====
const STORAGE_KEY = 'loonieBirdData';

function saveData() {
    const indicator = document.getElementById('saveIndicator');
    if(indicator) {
        indicator.textContent = '💾 Saving...';
        indicator.className = 'save-indicator saving';
    }
    
    const data = {
        lessons: lessons,
        blockedTimes: blockedTimes,
        studentProfiles: studentProfiles,
        swapRequests: swapRequests,
        payments: payments,
        lessonRates: lessonRates,
        seenNotifications: seenNotifications,
        nextId: nextId,
        nextSeriesId: nextSeriesId,
        nextBlockId: nextBlockId,
        nextSwapId: nextSwapId,
        nextPaymentId: nextPaymentId,
        darkMode: document.documentElement.getAttribute('data-theme') === 'dark'
    };
    
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        if(indicator) {
            setTimeout(() => {
                indicator.textContent = '✓ Saved';
                indicator.className = 'save-indicator saved';
                setTimeout(() => {
                    indicator.textContent = '💾 Saved';
                    indicator.className = 'save-indicator';
                }, 1500);
            }, 300);
        }
    } catch(e) {
        console.error('Failed to save data:', e);
        if(indicator) {
            indicator.textContent = '⚠️ Save failed';
            indicator.className = 'save-indicator';
        }
    }
}

function loadData() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            
            // Restore data
            if(data.lessons) lessons = data.lessons;
            if(data.blockedTimes) blockedTimes = data.blockedTimes;
            if(data.studentProfiles) studentProfiles = data.studentProfiles;
            if(data.swapRequests) swapRequests = data.swapRequests;
            if(data.payments) payments = data.payments;
            if(data.lessonRates) lessonRates = data.lessonRates;
            if(data.seenNotifications) seenNotifications = data.seenNotifications;
            if(data.nextId) nextId = data.nextId;
            if(data.nextSeriesId) nextSeriesId = data.nextSeriesId;
            if(data.nextBlockId) nextBlockId = data.nextBlockId;
            if(data.nextSwapId) nextSwapId = data.nextSwapId;
            if(data.nextPaymentId) nextPaymentId = data.nextPaymentId;
            if(data.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
            
            return true;
        }
    } catch(e) {
        console.error('Failed to load data:', e);
    }
    return false;
}

function clearAllData() {
    if(confirm('Clear ALL data and reset? This cannot be undone!')) {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload(true);
    }
}

function toggleDarkMode() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    
    if(isDark) {
        html.removeAttribute('data-theme');
    } else {
        html.setAttribute('data-theme', 'dark');
    }
    
    updateThemeIcon();
    saveData();
}

function updateThemeIcon() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const icon = isDark ? '☀️' : '🌙';
    const title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    
    const btn = document.getElementById('themeToggle');
    if(btn) {
        btn.textContent = icon;
        btn.title = title;
    }
    
    const loginBtn = document.getElementById('loginThemeToggle');
    if(loginBtn) {
        loginBtn.textContent = icon;
        loginBtn.title = title;
    }
}

// ===== CORE DATA =====
let lessons = [
    // Monday lessons
    {id: 1, firstName: "Emma", lastName: "Smith", day: 0, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-1", week: 0},
    {id: 2, firstName: "Noah", lastName: "Wilson", day: 0, time: "16:15", duration: 30, isRecurring: true, seriesId: "series-2", week: 0},
    {id: 3, firstName: "Ethan", lastName: "Miller", day: 0, time: "09:00", duration: 45, isRecurring: true, seriesId: "series-3", week: 0},
    {id: 4, firstName: "Mia", lastName: "Anderson", day: 0, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-4", week: 0},
    {id: 5, firstName: "Harper", lastName: "Thomas", day: 0, time: "17:00", duration: 45, isRecurring: true, seriesId: "series-5", week: 0},
    
    // Tuesday lessons
    {id: 6, firstName: "Liam", lastName: "Jones", day: 1, time: "16:00", duration: 45, isRecurring: true, seriesId: "series-6", week: 0},
    {id: 7, firstName: "Sophia", lastName: "Garcia", day: 1, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-7", week: 0},
    {id: 8, firstName: "Charlotte", lastName: "Moore", day: 1, time: "14:00", duration: 30, isRecurring: true, seriesId: "series-8", week: 0},
    {id: 9, firstName: "Benjamin", lastName: "Jackson", day: 1, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-9", week: 0},
    {id: 10, firstName: "Elijah", lastName: "White", day: 1, time: "17:00", duration: 45, isRecurring: true, seriesId: "series-10", week: 0},
    
    // Wednesday lessons
    {id: 11, firstName: "Olivia", lastName: "Davis", day: 2, time: "14:00", duration: 60, isRecurring: true, seriesId: "series-11", week: 0},
    {id: 12, firstName: "Mason", lastName: "Martinez", day: 2, time: "18:00", duration: 30, isRecurring: true, seriesId: "series-12", week: 0},
    {id: 13, firstName: "Amelia", lastName: "Harris", day: 2, time: "09:30", duration: 45, isRecurring: true, seriesId: "series-13", week: 0},
    {id: 14, firstName: "James", lastName: "Clark", day: 2, time: "11:00", duration: 60, isRecurring: true, seriesId: "series-14", week: 0},
    {id: 15, firstName: "Evelyn", lastName: "Lewis", day: 2, time: "15:30", duration: 30, isRecurring: true, seriesId: "series-15", week: 0},
    
    // Thursday lessons
    {id: 16, firstName: "Ava", lastName: "Brown", day: 3, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-16", week: 0},
    {id: 17, firstName: "Isabella", lastName: "Lee", day: 3, time: "11:00", duration: 60, isRecurring: true, seriesId: "series-17", week: 0},
    {id: 18, firstName: "Lucas", lastName: "Taylor", day: 3, time: "13:00", duration: 45, isRecurring: true, seriesId: "series-18", week: 0},
    {id: 19, firstName: "Alexander", lastName: "Robinson", day: 3, time: "16:30", duration: 30, isRecurring: true, seriesId: "series-19", week: 0},
    {id: 20, firstName: "Henry", lastName: "Walker", day: 3, time: "09:00", duration: 45, isRecurring: true, seriesId: "series-20", week: 0},
    
    // Friday lessons
    {id: 21, firstName: "Luna", lastName: "Hall", day: 4, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-21", week: 0},
    {id: 22, firstName: "Sebastian", lastName: "Allen", day: 4, time: "14:00", duration: 45, isRecurring: true, seriesId: "series-22", week: 0},
    {id: 23, firstName: "Aria", lastName: "Young", day: 4, time: "15:30", duration: 60, isRecurring: true, seriesId: "series-23", week: 0},
    {id: 24, firstName: "Jack", lastName: "King", day: 4, time: "17:00", duration: 30, isRecurring: true, seriesId: "series-24", week: 0},
    {id: 25, firstName: "Chloe", lastName: "Wright", day: 4, time: "11:30", duration: 60, isRecurring: true, seriesId: "series-25", week: 0},
    {id: 26, firstName: "Daniel", lastName: "Scott", day: 4, time: "13:00", duration: 45, isRecurring: true, seriesId: "series-26", week: 0},
    {id: 27, firstName: "Penelope", lastName: "Green", day: 4, time: "18:00", duration: 30, isRecurring: true, seriesId: "series-27", week: 0},
    {id: 28, firstName: "Owen", lastName: "Baker", day: 4, time: "19:00", duration: 60, isRecurring: true, seriesId: "series-28", week: 0}
];
let blockedTimes = [
    // Weekday lunch breaks
    {id: 1, day: 0, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 2, day: 1, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 3, day: 2, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 4, day: 3, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 5, day: 4, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    
    // Saturday - hourly blocks (day 5)
    {id: 6, day: 5, time: "08:00", duration: 60, reason: "Weekend", week: 0},
    {id: 7, day: 5, time: "09:00", duration: 60, reason: "Weekend", week: 0},
    {id: 8, day: 5, time: "10:00", duration: 60, reason: "Weekend", week: 0},
    {id: 9, day: 5, time: "11:00", duration: 60, reason: "Weekend", week: 0},
    {id: 10, day: 5, time: "12:00", duration: 60, reason: "Weekend", week: 0},
    {id: 11, day: 5, time: "13:00", duration: 60, reason: "Weekend", week: 0},
    {id: 12, day: 5, time: "14:00", duration: 60, reason: "Weekend", week: 0},
    {id: 13, day: 5, time: "15:00", duration: 60, reason: "Weekend", week: 0},
    {id: 14, day: 5, time: "16:00", duration: 60, reason: "Weekend", week: 0},
    {id: 15, day: 5, time: "17:00", duration: 60, reason: "Weekend", week: 0},
    {id: 16, day: 5, time: "18:00", duration: 60, reason: "Weekend", week: 0},
    {id: 17, day: 5, time: "19:00", duration: 60, reason: "Weekend", week: 0},
    {id: 18, day: 5, time: "20:00", duration: 60, reason: "Weekend", week: 0},
    
    // Sunday - hourly blocks (day 6)
    {id: 19, day: 6, time: "08:00", duration: 60, reason: "Weekend", week: 0},
    {id: 20, day: 6, time: "09:00", duration: 60, reason: "Weekend", week: 0},
    {id: 21, day: 6, time: "10:00", duration: 60, reason: "Weekend", week: 0},
    {id: 22, day: 6, time: "11:00", duration: 60, reason: "Weekend", week: 0},
    {id: 23, day: 6, time: "12:00", duration: 60, reason: "Weekend", week: 0},
    {id: 24, day: 6, time: "13:00", duration: 60, reason: "Weekend", week: 0},
    {id: 25, day: 6, time: "14:00", duration: 60, reason: "Weekend", week: 0},
    {id: 26, day: 6, time: "15:00", duration: 60, reason: "Weekend", week: 0},
    {id: 27, day: 6, time: "16:00", duration: 60, reason: "Weekend", week: 0},
    {id: 28, day: 6, time: "17:00", duration: 60, reason: "Weekend", week: 0},
    {id: 29, day: 6, time: "18:00", duration: 60, reason: "Weekend", week: 0},
    {id: 30, day: 6, time: "19:00", duration: 60, reason: "Weekend", week: 0},
    {id: 31, day: 6, time: "20:00", duration: 60, reason: "Weekend", week: 0},
    
    // Night hours (9pm-midnight) - hourly blocks for all days
    {id: 32, day: 0, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 33, day: 0, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 34, day: 0, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 35, day: 1, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 36, day: 1, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 37, day: 1, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 38, day: 2, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 39, day: 2, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 40, day: 2, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 41, day: 3, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 42, day: 3, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 43, day: 3, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 44, day: 4, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 45, day: 4, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 46, day: 4, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 47, day: 5, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 48, day: 5, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 49, day: 5, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 50, day: 6, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 51, day: 6, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 52, day: 6, time: "23:00", duration: 60, reason: "Closed", week: 0},
    
    // Early morning (midnight-8am) - hourly blocks for all days
    {id: 53, day: 0, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 54, day: 0, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 55, day: 0, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 56, day: 0, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 57, day: 0, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 58, day: 0, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 59, day: 0, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 60, day: 0, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 61, day: 1, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 62, day: 1, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 63, day: 1, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 64, day: 1, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 65, day: 1, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 66, day: 1, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 67, day: 1, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 68, day: 1, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 69, day: 2, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 70, day: 2, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 71, day: 2, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 72, day: 2, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 73, day: 2, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 74, day: 2, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 75, day: 2, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 76, day: 2, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 77, day: 3, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 78, day: 3, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 79, day: 3, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 80, day: 3, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 81, day: 3, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 82, day: 3, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 83, day: 3, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 84, day: 3, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 85, day: 4, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 86, day: 4, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 87, day: 4, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 88, day: 4, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 89, day: 4, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 90, day: 4, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 91, day: 4, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 92, day: 4, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 93, day: 5, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 94, day: 5, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 95, day: 5, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 96, day: 5, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 97, day: 5, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 98, day: 5, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 99, day: 5, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 100, day: 5, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 101, day: 6, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 102, day: 6, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 103, day: 6, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 104, day: 6, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 105, day: 6, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 106, day: 6, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 107, day: 6, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 108, day: 6, time: "07:00", duration: 60, reason: "Closed", week: 0}
];

let studentProfiles = [
    // Original students with full details
    {firstName: "Emma", lastName: "Smith", familyCode: "SMITH2013", dob: "2013-05-14", grade: "6th", school: "Minnehaha Academy", homeAddress: "2847 Lyndale Ave S, Minneapolis, MN 55408", guardianName: "Jennifer Smith", guardianPhone: "(612) 555-0142", guardianEmail: "jsmith@email.com", guardian2Name: "Michael Smith", guardian2Phone: "(612) 555-0143", guardian2Email: "msmith@email.com", photo: "", retired: false},
    {firstName: "Liam", lastName: "Jones", familyCode: "JONES2012", dob: "2012-09-22", grade: "7th", school: "Bryn Mawr Elementary", homeAddress: "1523 Penn Ave N, Minneapolis, MN 55411", guardianName: "Sarah Jones", guardianPhone: "(612) 555-0287", guardianEmail: "sjones@email.com", guardian2Name: "David Jones", guardian2Phone: "(612) 555-0288", guardian2Email: "djones@email.com", photo: "", retired: false},
    {firstName: "Olivia", lastName: "Davis", familyCode: "DAVIS2014", dob: "2014-03-08", grade: "5th", school: "Kenwood Elementary", homeAddress: "4219 Xerxes Ave S, Minneapolis, MN 55410", guardianName: "Amanda Davis", guardianPhone: "(612) 555-0391", guardianEmail: "adavis@email.com", guardian2Name: "Robert Davis", guardian2Phone: "(612) 555-0392", guardian2Email: "rdavis@email.com", photo: "", retired: false},
    
    // New students - Monday
    {firstName: "Noah", lastName: "Wilson", familyCode: "WILSON2015", dob: "2015-07-19", grade: "4th", school: "Clara Barton Elementary", homeAddress: "3815 Bryant Ave S, Minneapolis, MN 55409", guardianName: "Michelle Wilson", guardianPhone: "(612) 555-0445", guardianEmail: "mwilson@email.com", photo: "", retired: false},
    {firstName: "Ethan", lastName: "Miller", familyCode: "MILLER2011", dob: "2011-11-03", grade: "8th", school: "Southwest High School", homeAddress: "5128 Harriet Ave S, Minneapolis, MN 55419", guardianName: "Karen Miller", guardianPhone: "(612) 555-0512", guardianEmail: "kmiller@email.com", photo: "", retired: false},
    {firstName: "Mia", lastName: "Anderson", familyCode: "ANDERSON2016", dob: "2016-02-28", grade: "3rd", school: "Lake Harriet Lower", homeAddress: "4401 Chowen Ave S, Minneapolis, MN 55410", guardianName: "Lisa Anderson", guardianPhone: "(612) 555-0623", guardianEmail: "landerson@email.com", photo: "", retired: false},
    {firstName: "Harper", lastName: "Thomas", familyCode: "THOMAS2013", dob: "2013-08-15", grade: "6th", school: "Anwatin Middle School", homeAddress: "2920 Fremont Ave N, Minneapolis, MN 55411", guardianName: "Jessica Thomas", guardianPhone: "(612) 555-0734", guardianEmail: "jthomas@email.com", photo: "", retired: false},
    
    // New students - Tuesday
    {firstName: "Sophia", lastName: "Garcia", familyCode: "GARCIA2012", dob: "2012-04-22", grade: "7th", school: "Northeast Middle School", homeAddress: "1847 Central Ave NE, Minneapolis, MN 55418", guardianName: "Maria Garcia", guardianPhone: "(612) 555-0845", guardianEmail: "mgarcia@email.com", photo: "", retired: false},
    {firstName: "Charlotte", lastName: "Moore", familyCode: "MOORE2017", dob: "2017-01-09", grade: "2nd", school: "Dowling Elementary", homeAddress: "3920 46th Ave S, Minneapolis, MN 55406", guardianName: "Emily Moore", guardianPhone: "(612) 555-0956", guardianEmail: "emoore@email.com", photo: "", retired: false},
    {firstName: "Benjamin", lastName: "Jackson", familyCode: "JACKSON2010", dob: "2010-06-30", grade: "9th", school: "Washburn High School", homeAddress: "5005 Nicollet Ave S, Minneapolis, MN 55419", guardianName: "Patricia Jackson", guardianPhone: "(612) 555-1067", guardianEmail: "pjackson@email.com", photo: "", retired: false},
    {firstName: "Elijah", lastName: "White", familyCode: "WHITE2014", dob: "2014-12-11", grade: "5th", school: "Whittier Elementary", homeAddress: "2600 Blaisdell Ave S, Minneapolis, MN 55408", guardianName: "Stephanie White", guardianPhone: "(612) 555-1178", guardianEmail: "swhite@email.com", photo: "", retired: false},
    
    // New students - Wednesday
    {firstName: "Mason", lastName: "Martinez", familyCode: "MARTINEZ2015", dob: "2015-09-05", grade: "4th", school: "Jefferson Elementary", homeAddress: "1200 26th St NE, Minneapolis, MN 55418", guardianName: "Carmen Martinez", guardianPhone: "(612) 555-1289", guardianEmail: "cmartinez@email.com", photo: "", retired: false},
    {firstName: "Amelia", lastName: "Harris", familyCode: "HARRIS2013", dob: "2013-03-17", grade: "6th", school: "Ramsey Middle School", homeAddress: "4838 Emerson Ave N, Minneapolis, MN 55430", guardianName: "Rachel Harris", guardianPhone: "(612) 555-1390", guardianEmail: "rharris@email.com", photo: "", retired: false},
    {firstName: "James", lastName: "Clark", familyCode: "CLARK2011", dob: "2011-07-24", grade: "8th", school: "Anthony Middle School", homeAddress: "3301 Silver Lake Rd, Minneapolis, MN 55418", guardianName: "Susan Clark", guardianPhone: "(612) 555-1401", guardianEmail: "sclark@email.com", photo: "", retired: false},
    {firstName: "Evelyn", lastName: "Lewis", familyCode: "LEWIS2016", dob: "2016-10-02", grade: "3rd", school: "Armatage Elementary", homeAddress: "5645 Knox Ave S, Minneapolis, MN 55419", guardianName: "Angela Lewis", guardianPhone: "(612) 555-1512", guardianEmail: "alewis@email.com", photo: "", retired: false},
    
    // New students - Thursday
    {firstName: "Ava", lastName: "Brown", familyCode: "BROWN2014", dob: "2014-05-21", grade: "5th", school: "Bancroft Elementary", homeAddress: "3829 13th Ave S, Minneapolis, MN 55407", guardianName: "Nicole Brown", guardianPhone: "(612) 555-1623", guardianEmail: "nbrown@email.com", photo: "", retired: false},
    {firstName: "Isabella", lastName: "Lee", familyCode: "LEE2012", dob: "2012-08-14", grade: "7th", school: "Olson Middle School", homeAddress: "2817 James Ave N, Minneapolis, MN 55411", guardianName: "Grace Lee", guardianPhone: "(612) 555-1734", guardianEmail: "glee@email.com", photo: "", retired: false},
    {firstName: "Lucas", lastName: "Taylor", familyCode: "TAYLOR2013", dob: "2013-11-28", grade: "6th", school: "Sanford Middle School", homeAddress: "4101 Beard Ave S, Minneapolis, MN 55410", guardianName: "Megan Taylor", guardianPhone: "(612) 555-1845", guardianEmail: "mtaylor@email.com", photo: "", retired: false},
    {firstName: "Alexander", lastName: "Robinson", familyCode: "ROBINSON2015", dob: "2015-04-07", grade: "4th", school: "Loring Elementary", homeAddress: "2600 Hennepin Ave, Minneapolis, MN 55405", guardianName: "Christine Robinson", guardianPhone: "(612) 555-1956", guardianEmail: "crobinson@email.com", photo: "", retired: false},
    {firstName: "Henry", lastName: "Walker", familyCode: "WALKER2014", dob: "2014-01-19", grade: "5th", school: "Lyndale Elementary", homeAddress: "3411 5th Ave S, Minneapolis, MN 55408", guardianName: "Laura Walker", guardianPhone: "(612) 555-2067", guardianEmail: "lwalker@email.com", photo: "", retired: false},
    
    // New students - Friday
    {firstName: "Luna", lastName: "Hall", familyCode: "HALL2012", dob: "2012-06-13", grade: "7th", school: "Justice Page Middle School", homeAddress: "5045 Chicago Ave S, Minneapolis, MN 55417", guardianName: "Diana Hall", guardianPhone: "(612) 555-2178", guardianEmail: "dhall@email.com", photo: "", retired: false},
    {firstName: "Sebastian", lastName: "Allen", familyCode: "ALLEN2013", dob: "2013-09-26", grade: "6th", school: "Folwell Arts Magnet", homeAddress: "3611 Queen Ave N, Minneapolis, MN 55412", guardianName: "Katherine Allen", guardianPhone: "(612) 555-2289", guardianEmail: "kallen@email.com", photo: "", retired: false},
    {firstName: "Aria", lastName: "Young", familyCode: "YOUNG2011", dob: "2011-02-08", grade: "8th", school: "Roosevelt High School", homeAddress: "4029 28th Ave S, Minneapolis, MN 55406", guardianName: "Samantha Young", guardianPhone: "(612) 555-2390", guardianEmail: "syoung@email.com", photo: "", retired: false},
    {firstName: "Jack", lastName: "King", familyCode: "KING2016", dob: "2016-07-31", grade: "3rd", school: "Windom Elementary", homeAddress: "5821 Wentworth Ave S, Minneapolis, MN 55419", guardianName: "Rebecca King", guardianPhone: "(612) 555-2401", guardianEmail: "rking@email.com", photo: "", retired: false},
    
    // Additional students - Friday
    {firstName: "Chloe", lastName: "Wright", familyCode: "WRIGHT2010", dob: "2010-12-05", grade: "9th", school: "South High School", homeAddress: "3015 19th Ave S, Minneapolis, MN 55407", guardianName: "Heather Wright", guardianPhone: "(612) 555-2512", guardianEmail: "hwright@email.com", photo: "", retired: false},
    {firstName: "Daniel", lastName: "Scott", familyCode: "SCOTT2014", dob: "2014-04-18", grade: "5th", school: "Burroughs Elementary", homeAddress: "1601 50th St W, Minneapolis, MN 55419", guardianName: "Kimberly Scott", guardianPhone: "(612) 555-2623", guardianEmail: "kscott@email.com", photo: "", retired: false},
    {firstName: "Penelope", lastName: "Green", familyCode: "GREEN2017", dob: "2017-08-22", grade: "2nd", school: "Hale Elementary", homeAddress: "5445 Park Ave S, Minneapolis, MN 55417", guardianName: "Victoria Green", guardianPhone: "(612) 555-2734", guardianEmail: "vgreen@email.com", photo: "", retired: false},
    {firstName: "Owen", lastName: "Baker", familyCode: "BAKER2012", dob: "2012-10-14", grade: "7th", school: "Marcy Arts Magnet", homeAddress: "2620 Colfax Ave S, Minneapolis, MN 55408", guardianName: "Brittany Baker", guardianPhone: "(612) 555-2845", guardianEmail: "bbaker@email.com", photo: "", retired: false}
];

// ===== PAYMENT TRACKING =====
let payments = [
    // Emma Smith - fully paid
    {id: 1, studentKey: "Emma Smith", amount: 280, date: "2025-01-06", note: "January lessons - Check #1042", createdAt: "2025-01-06T10:00:00Z"},
    
    // Liam Jones - partial payment
    {id: 2, studentKey: "Liam Jones", amount: 110, date: "2025-01-08", note: "Venmo", createdAt: "2025-01-08T14:30:00Z"},
    
    // Olivia Davis - paid ahead
    {id: 3, studentKey: "Olivia Davis", amount: 350, date: "2025-01-02", note: "Jan + Feb prepaid - Zelle", createdAt: "2025-01-02T09:15:00Z"},
    
    // Sophia Garcia - recent payment
    {id: 4, studentKey: "Sophia Garcia", amount: 140, date: "2025-01-15", note: "Cash", createdAt: "2025-01-15T16:45:00Z"},
    
    // Benjamin Jackson - multiple payments
    {id: 5, studentKey: "Benjamin Jackson", amount: 70, date: "2025-01-03", note: "Week 1", createdAt: "2025-01-03T11:00:00Z"},
    {id: 6, studentKey: "Benjamin Jackson", amount: 70, date: "2025-01-10", note: "Week 2", createdAt: "2025-01-10T11:00:00Z"},
    
    // Chloe Wright - check payment
    {id: 7, studentKey: "Chloe Wright", amount: 210, date: "2025-01-12", note: "Check #5589", createdAt: "2025-01-12T10:30:00Z"},
    
    // Luna Hall - recent
    {id: 8, studentKey: "Luna Hall", amount: 140, date: "2025-01-20", note: "PayPal", createdAt: "2025-01-20T15:00:00Z"}
];
let nextPaymentId = 9;

// Default lesson rates by duration (in dollars)
let lessonRates = {
    30: 40,
    45: 55,
    60: 70
};

let swapRequests = [
    // A pending swap request - waiting for other student
    {id: 1, requestingStudent: "Noah Wilson", targetStudent: "Emma Smith", requestingLessonId: 2, targetLessonId: 1, status: "pending", timestamp: "2025-01-27T14:00:00Z"},
    // A student_agreed swap - both students agreed, needs teacher approval
    {id: 2, requestingStudent: "Liam Jones", targetStudent: "Sophia Garcia", requestingLessonId: 6, targetLessonId: 7, status: "student_agreed", timestamp: "2025-01-26T10:00:00Z", studentAgreedAt: "2025-01-27T09:30:00Z", agreedBy: "Sophia Garcia"},
    // An approved swap from last week
    {id: 3, requestingStudent: "Charlotte Moore", targetStudent: "Benjamin Jackson", requestingLessonId: 8, targetLessonId: 9, status: "approved", timestamp: "2025-01-20T10:00:00Z", studentAgreedAt: "2025-01-20T14:00:00Z", agreedBy: "Benjamin Jackson", resolvedAt: "2025-01-21T09:30:00Z", resolvedBy: "teacher"}
];
let nextSwapId = 4;
let loginMode = null;
let loggedInStudent = null;
let seenNotifications = {}; // Track which resolved swaps each student has seen

let nextId = 29;
let nextSeriesId = 29;
let nextBlockId = 109;
let draggedId = null;
let currentWeek = 0;
let tempEditData = null;
let tempNewData = null;

function isInPast(week, day) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    return targetDate < today;
}

function getActualDate(week, day) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    return targetDate;
}

function formatLessonDate(week, day) {
    const date = getActualDate(week, day);
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return dayNames[date.getDay()] + ', ' + monthNames[date.getMonth()] + ' ' + date.getDate();
}

function formatNamePrivate(firstName, lastName) {
    return firstName + ' ' + lastName.charAt(0) + '.';
}

const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
const allTimes = ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
const detailedTimes = ["08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00"];

function initializeRecurringLessons() {
    const baseRecurring = lessons.filter(l => l.isRecurring && l.week === 0);
    const newLessons = [];
    for(let week = -2; week <= 4; week++) {
        if(week === 0) continue;
        baseRecurring.forEach(baseLesson => {
            newLessons.push({
                id: nextId++,
                firstName: baseLesson.firstName,
                lastName: baseLesson.lastName,
                day: baseLesson.day,
                time: baseLesson.time,
                duration: baseLesson.duration,
                isRecurring: true,
                seriesId: baseLesson.seriesId,
                week: week
            });
        });
    }
    lessons.push(...newLessons);
}

function initializeRecurringBlocks() {
    const baseBlocks = blockedTimes.filter(b => b.week === 0);
    const newBlocks = [];
    for(let week = -2; week <= 52; week++) {
        if(week === 0) continue;
        baseBlocks.forEach(baseBlock => {
            newBlocks.push({
                id: nextBlockId++,
                day: baseBlock.day,
                time: baseBlock.time,
                duration: baseBlock.duration,
                reason: baseBlock.reason,
                week: week
            });
        });
    }
    blockedTimes.push(...newBlocks);
}

// Load saved data on startup
const hadSavedData = loadData();
if(!hadSavedData) {
    initializeRecurringLessons();
    initializeRecurringBlocks();
}
// Update theme icon on load
updateThemeIcon();

function loginAsTeacher() {
    loginMode = 'teacher';
    loggedInStudent = null;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('teacherControls').classList.remove('hidden');
    document.getElementById('studentControls').classList.add('hidden');
    document.getElementById('loginStatus').innerHTML = '👨‍🏫 Teacher Mode';
    render();
    toast("Logged in as Teacher");
}

function loginAsStudent() {
    const familyCode = document.getElementById('familyCodeInput').value.trim().toUpperCase();
    if(!familyCode) {
        toast("Please enter a family code");
        return;
    }
    const student = studentProfiles.find(p => p.familyCode === familyCode);
    if(!student) {
        toast("Invalid family code. Please try again.");
        return;
    }
    loginMode = 'student';
    loggedInStudent = {
        firstName: student.firstName,
        lastName: student.lastName,
        familyCode: student.familyCode
    };
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('teacherControls').classList.add('hidden');
    document.getElementById('studentControls').classList.remove('hidden');
    document.getElementById('loginStatus').innerHTML = '🎓 ' + student.firstName + ' ' + student.lastName;
    render();
    toast("Welcome, " + student.firstName + "!");
    
    // Check for swap request notifications
    setTimeout(() => checkSwapNotifications(), 500);
}

function checkSwapNotifications() {
    if(!loggedInStudent) return;
    
    const fullName = loggedInStudent.firstName + " " + loggedInStudent.lastName;
    
    // Initialize seen notifications for this student if needed
    if(!seenNotifications[fullName]) {
        seenNotifications[fullName] = [];
    }
    
    // Find resolved swap requests involving this student that they haven't seen
    const unreadNotifications = swapRequests.filter(r => 
        (r.status === 'approved' || r.status === 'declined') &&
        (r.requestingStudent === fullName || r.targetStudent === fullName) &&
        !seenNotifications[fullName].includes(r.id)
    );
    
    if(unreadNotifications.length > 0) {
        showSwapNotifications(unreadNotifications, fullName);
    }
}

function showSwapNotifications(notifications, fullName) {
    let html = "<h3 class='modal-title'>🔔 Swap Request Updates</h3>" +
        "<p class='modal-subtitle'>Updates since your last login</p>";
    
    notifications.forEach(request => {
        const isRequester = request.requestingStudent === fullName;
        const otherStudent = isRequester ? request.targetStudent : request.requestingStudent;
        const otherNamePrivate = formatNamePrivate(otherStudent.split(' ')[0], otherStudent.split(' ')[1]);
        
        const myLesson = lessons.find(l => l.id === (isRequester ? request.requestingLessonId : request.targetLessonId));
        const theirLesson = lessons.find(l => l.id === (isRequester ? request.targetLessonId : request.requestingLessonId));
        
        if(request.status === 'approved') {
            html += "<div class='info-box info-box-success' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>✅ Swap Accepted!</div>";
            
            if(isRequester) {
                html += "<p style='font-size: 0.875rem;'>Your swap request with <strong>" + otherNamePrivate + "</strong> was accepted!</p>";
            } else {
                html += "<p style='font-size: 0.875rem;'>You accepted a swap with <strong>" + otherNamePrivate + "</strong>.</p>";
            }
            
            if(myLesson && theirLesson) {
                html += "<p style='font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.9;'>" +
                    "Your new time: <strong>" + days[myLesson.day] + " at " + myLesson.time + "</strong>" +
                    "</p>";
            }
            
            html += "</div>";
        } else if(request.status === 'declined') {
            html += "<div class='info-box info-box-danger' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>❌ Swap Declined</div>";
            
            if(isRequester) {
                html += "<p style='font-size: 0.875rem;'>Your swap request with <strong>" + otherNamePrivate + "</strong> was declined.</p>" +
                    "<p style='font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.9;'>Your lesson remains at its original time.</p>";
            } else {
                html += "<p style='font-size: 0.875rem;'>You declined a swap request from <strong>" + otherNamePrivate + "</strong>.</p>";
            }
            
            html += "</div>";
        }
        
        // Mark as seen
        seenNotifications[fullName].push(request.id);
    });
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-primary'>Got It</button>";
    
    modal(html);
}

function logout() {
    loginMode = null;
    loggedInStudent = null;
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('familyCodeInput').value = '';
    toast("Logged out successfully");
}

function render() {
    const weekLessons = lessons.filter(l => l.week === currentWeek);
    const times = allTimes;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeek * 7));
    
    let html = "<table class='calendar-table'><thead><tr><th>Time</th>";
    days.forEach((d, i) => {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + i);
        const monthDay = (dayDate.getMonth() + 1) + '/' + dayDate.getDate();
        const year = dayDate.getFullYear();
        const isToday = dayDate.getTime() === today.getTime();
        const isPast = dayDate < today;
        
        let headerClass = isToday ? 'today-header' : (isPast ? 'past-header' : '');
        html += "<th class='" + headerClass + "'>" +
                "<div class='day-name'>" + d + "</div>" +
                "<div class='day-date'>" + monthDay + "/" + year + "</div>" +
                "</th>";
    });
    html += "</tr></thead><tbody>";
    
    // Save data after render (debounced)
    clearTimeout(window.saveTimeout);
    window.saveTimeout = setTimeout(saveData, 500);
    
    times.forEach(time => {
        const hour = time.split(':')[0];
        html += "<tr><td>" + time + "</td>";
        
        for(let d = 0; d < 7; d++) {
            const cellDate = new Date(startOfWeek);
            cellDate.setDate(startOfWeek.getDate() + d);
            const isPastDay = cellDate < today;
            
            const dayLessons = weekLessons.filter(l => l.day === d && l.time.startsWith(hour));
            const cellClass = isPastDay ? 'drop-zone past-day' : 'drop-zone';
            html += "<td class='" + cellClass + "' data-day='" + d + "' data-time='" + time + "' ";
            
            if(loginMode === 'teacher') {
                html += "ondrop='drop(event)' ondragover='dragover(event)' ondragleave='dragleave(event)' ";
                html += "onclick='handleCellClick(" + d + ", \"" + time + "\")'>";
            } else {
                html += ">";
            }
            
            // Find blocks that cover this hour (start in this hour OR span into this hour)
            const hourInt = parseInt(hour);
            const relevantBlocks = blockedTimes.filter(b => {
                if(b.week !== currentWeek || b.day !== d) return false;
                const blockStartHour = parseInt(b.time.split(':')[0]);
                const blockStartMinutes = parseInt(b.time.split(':')[1]);
                const blockEndMinutes = blockStartHour * 60 + blockStartMinutes + b.duration;
                const blockEndHour = Math.floor(blockEndMinutes / 60);
                const cellStartMinutes = hourInt * 60;
                const cellEndMinutes = (hourInt + 1) * 60;
                // Block overlaps this cell if it starts before cell ends and ends after cell starts
                return (blockStartHour * 60 + blockStartMinutes) < cellEndMinutes && blockEndMinutes > cellStartMinutes;
            });
            
            relevantBlocks.forEach(block => {
                const blockStartHour = parseInt(block.time.split(':')[0]);
                const blockStartMinutes = parseInt(block.time.split(':')[1]);
                const blockTotalStartMinutes = blockStartHour * 60 + blockStartMinutes;
                const blockTotalEndMinutes = blockTotalStartMinutes + block.duration;
                
                const cellStartMinutes = hourInt * 60;
                const cellEndMinutes = (hourInt + 1) * 60;
                
                // Calculate where the block appears within this cell
                const visibleStartMinutes = Math.max(blockTotalStartMinutes, cellStartMinutes);
                const visibleEndMinutes = Math.min(blockTotalEndMinutes, cellEndMinutes);
                
                const topOffset = visibleStartMinutes - cellStartMinutes;
                const visibleDuration = visibleEndMinutes - visibleStartMinutes;
                
                const topPosition = (topOffset / 60) * 80;
                const blockHeight = (visibleDuration / 60) * 80;
                
                const blockCursorStyle = (loginMode === 'student') ? "cursor: default;" : "cursor: pointer;";
                
                // Determine if this is a continuation segment (for border styling)
                const startsInThisCell = blockTotalStartMinutes >= cellStartMinutes && blockTotalStartMinutes < cellEndMinutes;
                const endsInThisCell = blockTotalEndMinutes > cellStartMinutes && blockTotalEndMinutes <= cellEndMinutes;
                
                let borderRadius = "0";
                let borderStyle = "border: 1px solid var(--stone-400);";
                
                if(startsInThisCell && endsInThisCell) {
                    borderRadius = "8px";
                } else if(startsInThisCell) {
                    borderRadius = "8px 8px 0 0";
                    borderStyle = "border: 1px solid var(--stone-400); border-bottom: none;";
                } else if(endsInThisCell) {
                    borderRadius = "0 0 8px 8px";
                    borderStyle = "border: 1px solid var(--stone-400); border-top: none;";
                } else {
                    // Middle segment
                    borderStyle = "border-left: 1px solid var(--stone-400); border-right: 1px solid var(--stone-400); border-top: none; border-bottom: none;";
                }
                
                // For students: show no text at all (just black box)
                // For teachers: only show reason label in the first cell where block starts
                let displayReason = '';
                if(loginMode !== 'student' && startsInThisCell) {
                    displayReason = (block.reason === 'Closed' || block.reason === 'Weekend') ? '' : '🚫 ' + block.reason;
                }
                
                // Build the onclick handler for teachers
                let onclickAttr = '';
                if(loginMode !== 'student') {
                    onclickAttr = ' onclick="event.stopPropagation(); showBlockDetails(' + block.id + ')"';
                }
                
                html += '<div class="blocked-slot" style="top:' + topPosition + 'px; height:' + blockHeight + 'px; border-radius:' + borderRadius + '; ' + borderStyle + ' ' + blockCursorStyle + '"' + onclickAttr + '>';
                html += displayReason;
                html += '</div>';
            });
            
            dayLessons.forEach((lesson, index) => {
                const name = lesson.firstName + " " + lesson.lastName.charAt(0) + ".";
                const isPastLesson = isInPast(lesson.week, lesson.day);
                let heightClass = lesson.duration === 30 ? 'lesson-30' : lesson.duration === 45 ? 'lesson-45' : 'lesson-60';
                
                const timeParts = lesson.time.split(':');
                const minutes = parseInt(timeParts[1]);
                const snappedMinutes = Math.round(minutes / 15) * 15;
                const topPosition = (snappedMinutes / 60) * 80;
                
                let column = 0;
                let totalColumns = 1;
                
                const allDayLessons = weekLessons.filter(l => l.day === d && l.week === currentWeek);
                const lessonStartMinutes = timeToMinutes(lesson.time);
                const lessonEndMinutes = lessonStartMinutes + lesson.duration;
                
                const overlapping = allDayLessons.filter((other) => {
                    if(other.id === lesson.id) return false;
                    const otherStartMinutes = timeToMinutes(other.time);
                    const otherEndMinutes = otherStartMinutes + other.duration;
                    return (lessonStartMinutes < otherEndMinutes && lessonEndMinutes > otherStartMinutes);
                });
                
                if(overlapping.length > 0) {
                    totalColumns = overlapping.length + 1;
                    const allLessons = [lesson, ...overlapping].sort((a, b) => {
                        const timeCompare = a.time.localeCompare(b.time);
                        if(timeCompare !== 0) return timeCompare;
                        return a.id - b.id;
                    });
                    column = allLessons.findIndex(l => l.id === lesson.id);
                }
                
                const width = totalColumns > 1 ? (100 / totalColumns) : 100;
                const leftPosition = totalColumns > 1 ? (column * width) : 0;
                
                let colorClass = totalColumns > 1 ? ' lesson-overlap-' + (column % 6) : ' lesson-overlap-0';
                
                if(loginMode === 'student' && loggedInStudent) {
                    if(lesson.firstName === loggedInStudent.firstName && lesson.lastName === loggedInStudent.lastName) {
                        colorClass = ' my-lesson';
                    }
                }
                
                const draggableAttr = (isPastLesson || loginMode === 'student') ? "draggable='false'" : "draggable='true' ondragstart='dragstart(event)' ondragend='dragend(event)'";
                const cursorStyle = (isPastLesson || loginMode === 'student') ? "cursor: default;" : "";
                const clickableAttr = (loginMode === 'student') ? "" : "onclick='showDetails(" + lesson.id + ")'";
                
                html += "<div class='lesson-slot " + heightClass + colorClass + "' style='top:" + topPosition + "px; left:" + leftPosition + "%; width:" + width + "%; " + cursorStyle + "' " + draggableAttr + " data-id='" + lesson.id + "' " + clickableAttr + ">";
                html += "<div class='student-name'>" + name + "</div>";
                html += "</div>";
            });
            
            html += "</td>";
        }
        html += "</tr>";
    });
    html += "</tbody></table>";
    document.getElementById("calendar").innerHTML = html;
    
    updateWeekLabel();
    updateMySwapBadge();
    updateTeacherSwapBadge();
    setTimeout(scrollTo8AM, 0);
}

function scrollTo8AM() {
    const calendarWrapper = document.querySelector('.calendar-wrapper');
    if(calendarWrapper) {
        const scrollPosition = 8 * 82;
        calendarWrapper.scrollTop = scrollPosition;
    }
}

function changeWeek(direction) {
    currentWeek += direction;
    render();
}

function updateWeekLabel() {
    const label = document.getElementById('weekLabel');
    const label2 = document.getElementById('weekLabel2');
    let text = 'Today';
    if(currentWeek === 1) text = 'Next Week';
    else if(currentWeek === -1) text = 'Last Week';
    else if(currentWeek > 0) text = currentWeek + ' Weeks Ahead';
    else if(currentWeek < 0) text = Math.abs(currentWeek) + ' Weeks Ago';
    
    if(label) label.textContent = text;
    if(label2) label2.textContent = text;
}

function updateMySwapBadge() {
    if(loginMode !== 'student' || !loggedInStudent) return;
    
    const fullName = loggedInStudent.firstName + " " + loggedInStudent.lastName;
    const pendingCount = swapRequests.filter(r => 
        r.status === 'pending' && 
        (r.requestingStudent === fullName || r.targetStudent === fullName)
    ).length;
    
    const badge = document.getElementById('mySwapBadge');
    if(!badge) return;
    
    if(pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function updateTeacherSwapBadge() {
    if(loginMode !== 'teacher') return;
    
    const pendingCount = swapRequests.filter(r => r.status === 'pending' || r.status === 'student_agreed').length;
    const btn = document.getElementById('teacherSwapBtn');
    if(!btn) return;
    
    // Remove existing badge if any
    const existingBadge = btn.querySelector('.badge');
    if(existingBadge) existingBadge.remove();
    
    if(pendingCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = pendingCount;
        // Make badge more prominent if there are student_agreed requests needing approval
        const needsApproval = swapRequests.filter(r => r.status === 'student_agreed').length;
        if(needsApproval > 0) {
            badge.style.background = 'var(--teal-600)';
        }
        btn.appendChild(badge);
    }
}

function showTeacherSwapRequests() {
    const pending = swapRequests.filter(r => r.status === 'pending');
    const studentAgreed = swapRequests.filter(r => r.status === 'student_agreed');
    const approved = swapRequests.filter(r => r.status === 'approved');
    const declined = swapRequests.filter(r => r.status === 'declined');
    
    let html = "<h3 class='modal-title'>🔄 Swap Requests</h3>" +
        "<p class='modal-subtitle'>View and manage student swap requests</p>";
    
    // Summary stats
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;'>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--teal-100); border-radius: 10px;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: var(--teal-700);'>" + studentAgreed.length + "</div>" +
        "<div style='font-size: 0.7rem; color: var(--teal-600);'>Needs Approval</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--amber-100); border-radius: 10px;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: var(--amber-700);'>" + pending.length + "</div>" +
        "<div style='font-size: 0.7rem; color: var(--amber-600);'>Pending Student</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--emerald-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + approved.length + "</div>" +
        "<div style='font-size: 0.7rem; color: white;'>Completed</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--rose-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + declined.length + "</div>" +
        "<div style='font-size: 0.7rem; color: white;'>Declined</div>" +
        "</div>" +
        "</div>";
    
    if(swapRequests.length === 0) {
        html += "<div class='info-box info-box-info'>No swap requests yet. Students can request swaps from their portal.</div>";
    } else {
        html += "<div class='scroll-container' style='max-height: 400px;'>";
        
        // Student agreed - needs teacher approval (highest priority)
        if(studentAgreed.length > 0) {
            html += "<div class='section-title' style='color: var(--teal-600);'>✋ Needs Your Approval</div>";
            html += "<p style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.75rem;'>Both students have agreed. Approve to complete the swap.</p>";
            studentAgreed.forEach(request => {
                html += renderSwapRequestCard(request, true);
            });
        }
        
        // Pending requests - waiting for other student
        if(pending.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--amber-600);'>⏳ Awaiting Student Response</div>";
            html += "<p style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.75rem;'>Waiting for the other student to accept or decline.</p>";
            pending.forEach(request => {
                html += renderSwapRequestCard(request, true);
            });
        }
        
        // Accepted requests
        if(approved.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--emerald-600);'>✅ Completed</div>";
            approved.forEach(request => {
                html += renderSwapRequestCard(request, false);
            });
        }
        
        // Declined requests
        if(declined.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--rose-600);'>❌ Declined</div>";
            declined.forEach(request => {
                html += renderSwapRequestCard(request, false);
            });
        }
        
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function renderSwapRequestCard(request, showActions) {
    const lesson1 = lessons.find(l => l.id === request.requestingLessonId);
    const lesson2 = lessons.find(l => l.id === request.targetLessonId);
    
    let statusClass = '';
    let statusIcon = '';
    let statusLabel = '';
    if(request.status === 'student_agreed') {
        statusClass = 'info-box-info';
        statusIcon = '✋';
        statusLabel = 'Students Agreed';
    } else if(request.status === 'pending') {
        statusClass = 'info-box-warning';
        statusIcon = '⏳';
        statusLabel = 'Pending';
    } else if(request.status === 'approved') {
        statusClass = 'info-box-success';
        statusIcon = '✅';
        statusLabel = 'Completed';
    } else {
        statusClass = 'info-box-danger';
        statusIcon = '❌';
        statusLabel = 'Declined';
    }
    
    let html = "<div class='info-box " + statusClass + "' style='margin-bottom: 0.75rem; padding: 1rem;'>";
    
    // Header with timestamp
    const requestDate = new Date(request.timestamp);
    html += "<div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;'>" +
        "<span style='font-weight: 700;'>" + statusIcon + " " + statusLabel + "</span>" +
        "<span style='font-size: 0.7rem; opacity: 0.7;'>Requested " + requestDate.toLocaleDateString() + "</span>" +
        "</div>";
    
    // Requester info
    html += "<div style='font-size: 0.875rem; margin-bottom: 0.5rem;'>" +
        "<strong>" + request.requestingStudent + "</strong> wants:";
    
    if(lesson1) {
        html += "<div style='margin-left: 1rem; font-size: 0.8rem; color: var(--stone-600);'>" +
            days[lesson1.day] + " at " + lesson1.time + " (" + lesson1.duration + " min)" +
            "</div>";
    }
    
    html += "</div>";
    
    // Arrow
    html += "<div style='text-align: center; color: var(--stone-400); font-size: 1rem;'>⬍</div>";
    
    // Target info
    html += "<div style='font-size: 0.875rem; margin-top: 0.5rem;'>" +
        "<strong>" + request.targetStudent + "</strong>'s time:";
    
    if(lesson2) {
        html += "<div style='margin-left: 1rem; font-size: 0.8rem; color: var(--stone-600);'>" +
            days[lesson2.day] + " at " + lesson2.time + " (" + lesson2.duration + " min)" +
            "</div>";
    }
    
    html += "</div>";
    
    // Show info about student agreement
    if(request.status === 'student_agreed' && request.studentAgreedAt) {
        const agreedDate = new Date(request.studentAgreedAt);
        const formattedDate = agreedDate.toLocaleDateString();
        const formattedTime = agreedDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        
        html += "<div style='font-size: 0.75rem; margin-top: 0.75rem; padding: 0.5rem; background: var(--teal-50); border-radius: 6px; color: var(--teal-700);'>" +
            "✓ " + (request.agreedBy || request.targetStudent) + " agreed on " + formattedDate + " at " + formattedTime +
            "</div>";
    }
    
    // Resolution info for resolved requests
    if((request.status === 'approved' || request.status === 'declined') && request.resolvedAt) {
        const resolvedDate = new Date(request.resolvedAt);
        const formattedDate = resolvedDate.toLocaleDateString();
        const formattedTime = resolvedDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        
        let resolutionText = '';
        if(request.status === 'approved') {
            resolutionText = "Approved by teacher on " + formattedDate + " at " + formattedTime;
        } else {
            if(request.resolvedBy === 'teacher') {
                resolutionText = "Declined by teacher on " + formattedDate + " at " + formattedTime;
            } else {
                resolutionText = "Declined by " + request.targetStudent + " on " + formattedDate + " at " + formattedTime;
            }
        }
        
        html += "<div style='font-size: 0.7rem; margin-top: 0.75rem; opacity: 0.7; font-style: italic;'>" +
            resolutionText +
            "</div>";
    }
    
    // Action buttons
    if(showActions) {
        if(request.status === 'student_agreed') {
            // Both students agreed - teacher just needs to approve
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='teacherApproveSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--teal-600); color: white;'>✓ Approve Swap</button>" +
                "<button onclick='teacherDeclineSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>";
        } else if(request.status === 'pending') {
            // Still waiting for student - teacher can approve directly or decline
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='teacherApproveSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Approve Now</button>" +
                "<button onclick='teacherDeclineSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>" +
                "<p style='font-size: 0.7rem; color: var(--stone-400); margin-top: 0.5rem; text-align: center;'>Or wait for " + request.targetStudent + " to respond</p>";
        }
    }
    
    html += "</div>";
    
    return html;
}

function teacherApproveSwap(requestId) {
    const request = swapRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const lesson1 = lessons.find(l => l.id === request.requestingLessonId);
    const lesson2 = lessons.find(l => l.id === request.targetLessonId);
    
    if(!lesson1 || !lesson2) {
        toast("Error: Lessons not found");
        return;
    }
    
    // Swap the times
    const tempDay = lesson1.day;
    const tempTime = lesson1.time;
    lesson1.day = lesson2.day;
    lesson1.time = lesson2.time;
    lesson2.day = tempDay;
    lesson2.time = tempTime;
    
    // Break from recurring series
    if(lesson1.isRecurring) { lesson1.isRecurring = false; lesson1.seriesId = null; }
    if(lesson2.isRecurring) { lesson2.isRecurring = false; lesson2.seriesId = null; }
    
    request.status = 'approved';
    request.resolvedAt = new Date().toISOString();
    request.resolvedBy = 'teacher';
    
    toast("Swap approved!");
    saveData();
    render();
    showTeacherSwapRequests();
}

function teacherDeclineSwap(requestId) {
    const request = swapRequests.find(r => r.id === requestId);
    if(request) {
        request.status = 'declined';
        request.resolvedAt = new Date().toISOString();
        request.resolvedBy = 'teacher';
    }
    toast("Swap declined");
    saveData();
    showTeacherSwapRequests();
}

function goToToday() {
    currentWeek = 0;
    render();
}

function dragstart(e) {
    draggedId = parseInt(e.target.getAttribute('data-id'));
    e.target.classList.add('dragging');
    e.stopPropagation();
}

function dragend(e) {
    e.target.classList.remove('dragging');
}

function dragover(e) {
    e.preventDefault();
}

function dragleave(e) {}

function drop(e) {
    e.preventDefault();
    if(!draggedId) return;
    
    const newDay = parseInt(e.currentTarget.getAttribute('data-day'));
    
    if(isInPast(currentWeek, newDay)) {
        draggedId = null;
        toast("Cannot move lessons to past dates");
        return;
    }
    
    const lesson = lessons.find(l => l.id === draggedId);
    const baseTime = e.currentTarget.getAttribute('data-time');
    
    const rect = e.currentTarget.getBoundingClientRect();
    const y = e.clientY - rect.top;
    const cellHeight = 80;
    const percentDown = Math.max(0, Math.min(y / cellHeight, 1));
    let minuteSlot;
    if(percentDown < 0.25) minuteSlot = 0;
    else if(percentDown < 0.5) minuteSlot = 15;
    else if(percentDown < 0.75) minuteSlot = 30;
    else minuteSlot = 45;
    
    const hour = baseTime.split(':')[0];
    const newTime = hour + ':' + minuteSlot.toString().padStart(2, '0');
    
    if(lesson.isRecurring && lesson.seriesId) {
        showRecurringMovePrompt(lesson, newDay, newTime);
    } else {
        performMove(lesson.id, newDay, newTime);
    }
    
    draggedId = null;
}

function showRecurringMovePrompt(lesson, newDay, newTime) {
    const name = lesson.firstName + " " + lesson.lastName;
    const html = "<h3 class='modal-title'>Move Recurring Lesson?</h3>" +
        "<p class='mb-4'>Moving <strong>" + name + "</strong> to " + days[newDay] + " at " + newTime + ".</p>" +
        "<p class='text-sm mb-4' style='color: var(--stone-500);'>Apply this change to:</p>" +
        "<button onclick='performMove(" + lesson.id + "," + newDay + ",\"" + newTime + "\",false)' class='modal-btn modal-btn-warning'>" +
        "Only This Lesson<br><span style='font-size: 0.8rem; opacity: 0.9;'>Move just this single occurrence</span>" +
        "</button>" +
        "<button onclick='performMove(" + lesson.id + "," + newDay + ",\"" + newTime + "\",true)' class='modal-btn modal-btn-primary'>" +
        "All Future Lessons<br><span style='font-size: 0.8rem; opacity: 0.9;'>Move all lessons in this series</span>" +
        "</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function performMove(lessonId, newDay, newTime, applyToAll) {
    const lesson = lessons.find(l => l.id === lessonId);
    const conflicts = checkConflict(newDay, newTime, lesson.duration, lessonId);
    
    if(conflicts.length > 0) {
        closeModal();
        showConflictWarning(conflicts, lesson, newDay, newTime, applyToAll);
    } else {
        if(applyToAll && lesson.isRecurring && lesson.seriesId) {
            const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
            sameSeries.forEach(l => {
                l.day = newDay;
                l.time = newTime;
            });
            closeModal();
            toast(lesson.firstName + " series moved to " + days[newDay] + " at " + newTime);
        } else {
            lesson.day = newDay;
            lesson.time = newTime;
            closeModal();
            toast(lesson.firstName + " moved to " + days[newDay] + " at " + newTime);
        }
        render();
    }
}

function checkConflict(day, time, duration, excludeId) {
    const startMinutes = timeToMinutes(time);
    const endMinutes = startMinutes + duration;
    
    let excludeStudentName = null;
    if(excludeId) {
        const excludeLesson = lessons.find(l => l.id === excludeId);
        if(excludeLesson) {
            excludeStudentName = excludeLesson.firstName + " " + excludeLesson.lastName;
        }
    }
    
    return lessons.filter(l => {
        if(l.id === excludeId) return false;
        if(l.day !== day) return false;
        if(l.week !== currentWeek) return false;
        
        if(excludeStudentName) {
            const lessonStudentName = l.firstName + " " + l.lastName;
            if(lessonStudentName === excludeStudentName) return false;
        }
        
        const lessonStart = timeToMinutes(l.time);
        const lessonEnd = lessonStart + l.duration;
        return (startMinutes < lessonEnd && endMinutes > lessonStart);
    });
}

function timeToMinutes(time) {
    const parts = time.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function showConflictWarning(conflicts, lesson, newDay, newTime, applyToAll) {
    const conflictList = conflicts.map(c => {
        const name = c.firstName + " " + c.lastName;
        const endTime = addMinutes(c.time, c.duration);
        const dateInfo = getDateForLesson(c);
        return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
               "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
               c.time + " to " + endTime + " (" + c.duration + " min)</div>";
    }).join('');
    
    const applyToAllParam = applyToAll ? ',true' : ',false';
    
    const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
        "<p class='mb-4'>This lesson overlaps with existing lessons:</p>" +
        "<div class='conflict-list'>" + conflictList + "</div>" +
        "<p class='text-sm mb-4' style='color: var(--stone-500);'>Both lessons will appear side-by-side in the calendar. Schedule anyway?</p>" +
        "<button onclick='overrideConflict(" + lesson.id + "," + newDay + ",\"" + newTime + "\"" + applyToAllParam + ")' class='modal-btn modal-btn-warning'>Schedule Anyway</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function addMinutes(time, minutes) {
    const total = timeToMinutes(time) + minutes;
    const hours = Math.floor(total / 60);
    const mins = total % 60;
    return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
}

function overrideConflict(lessonId, newDay, newTime, applyToAll) {
    const lesson = lessons.find(l => l.id === lessonId);
    
    if(applyToAll && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.day = newDay;
            l.time = newTime;
        });
        toast(lesson.firstName + " series moved - lessons will appear side-by-side");
    } else {
        lesson.day = newDay;
        lesson.time = newTime;
        toast(lesson.firstName + " moved - lessons will appear side-by-side");
    }
    
    closeModal();
    render();
}

function showDetails(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    const isPast = isInPast(lesson.week, lesson.day);
    
    const isMyLesson = loginMode === 'student' && loggedInStudent && 
                       lesson.firstName === loggedInStudent.firstName && 
                       lesson.lastName === loggedInStudent.lastName;
    
    let html = "<h3 class='modal-title'>Lesson Details</h3>";
    
    if(isPast) {
        html += "<div class='info-box info-box-info mb-4'>📅 Past lesson (read-only)</div>";
    }
    
    html += "<div class='mb-4'>" +
        "<div class='detail-row'><span class='detail-label'>Student</span><span class='detail-value'>" + name + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Day</span><span class='detail-value'>" + days[lesson.day] + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Time</span><span class='detail-value'>" + lesson.time + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Duration</span><span class='detail-value'>" + lesson.duration + " minutes</span></div>" +
        "</div>";
    
    if(lesson.isRecurring) {
        html += "<div class='recurring-badge'>🔁 Recurring weekly</div><br><br>";
    }
    
    if(loginMode === 'teacher' && !isPast) {
        html += "<button onclick='showEdit(" + id + ")' class='modal-btn modal-btn-primary'>Edit</button>" +
            "<button onclick='deleteLesson(" + id + ")' class='modal-btn modal-btn-danger'>Delete</button>";
    }
    
    if(loginMode === 'student' && isMyLesson && !isPast) {
        html += "<button onclick='showStudentSwapOptions(" + id + ",\"" + loggedInStudent.firstName + "\",\"" + loggedInStudent.lastName + "\")' class='modal-btn modal-btn-violet'>🔄 Request Swap</button>";
    }
    
    if(loginMode === 'student' && !isMyLesson) {
        html += "<div class='info-box info-box-info'>This is " + name + "'s lesson. You can only request swaps for your own lessons.</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Close</button>";
    
    modal(html);
}

function showEdit(id) {
    const lesson = lessons.find(l => l.id === id);
    
    const html = "<h3 class='modal-title'>Edit Lesson</h3>" +
        "<label class='form-label'>First Name</label>" +
        "<input id='editFirst' value='" + lesson.firstName + "' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input id='editLast' value='" + lesson.lastName + "' class='form-input'>" +
        "<label class='form-label'>Day</label>" +
        "<select id='editDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'" + (i===lesson.day?" selected":"") + ">" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='editTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'" + (t===lesson.time?" selected":"") + ">" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='editDuration' class='form-select'>" +
        "<option value='30'" + (lesson.duration===30?" selected":"") + ">30 minutes</option>" +
        "<option value='45'" + (lesson.duration===45?" selected":"") + ">45 minutes</option>" +
        "<option value='60'" + (lesson.duration===60?" selected":"") + ">60 minutes</option></select>" +
        (lesson.isRecurring ? 
            "<label class='form-checkbox'>" +
            "<input type='checkbox' id='editAllRecurring'>" +
            "<span style='color: var(--coral-500);'>Apply changes to all future lessons in this series</span>" +
            "</label>" : "") +
        "<button onclick='saveEdit(" + id + ")' class='modal-btn modal-btn-primary'>Save</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveEdit(id) {
    const lesson = lessons.find(l => l.id === id);
    const newDay = parseInt(document.getElementById('editDay').value);
    const newTime = document.getElementById('editTime').value;
    const newDuration = parseInt(document.getElementById('editDuration').value);
    const editAllCheckbox = document.getElementById('editAllRecurring');
    const editAllFuture = editAllCheckbox && editAllCheckbox.checked;
    
    tempEditData = {
        id: id,
        firstName: document.getElementById('editFirst').value,
        lastName: document.getElementById('editLast').value,
        day: newDay,
        time: newTime,
        duration: newDuration,
        editAllFuture: editAllFuture
    };
    
    const conflicts = checkConflict(newDay, newTime, newDuration, id);
    
    if(conflicts.length > 0) {
        closeModal();
        const conflictList = conflicts.map(c => {
            const name = c.firstName + " " + c.lastName;
            const endTime = addMinutes(c.time, c.duration);
            const dateInfo = getDateForLesson(c);
            return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
                   "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
                   c.time + " to " + endTime + " (" + c.duration + " min)</div>";
        }).join('');
        
        const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
            "<p class='mb-4'>This change creates conflicts:</p>" +
            "<div class='conflict-list'>" + conflictList + "</div>" +
            "<button onclick='forceEdit(" + id + ")' class='modal-btn modal-btn-warning'>Save Anyway</button>" +
            "<button onclick='showEdit(" + id + ")' class='modal-btn modal-btn-secondary'>Go Back</button>";
        
        modal(html);
        return;
    }
    
    if(editAllFuture && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.firstName = document.getElementById('editFirst').value;
            l.lastName = document.getElementById('editLast').value;
            l.day = newDay;
            l.time = newTime;
            l.duration = newDuration;
        });
        toast("Updated all lessons in series!");
    } else {
        lesson.firstName = document.getElementById('editFirst').value;
        lesson.lastName = document.getElementById('editLast').value;
        lesson.day = newDay;
        lesson.time = newTime;
        lesson.duration = newDuration;
        toast("Lesson updated!");
    }
    
    closeModal();
    render();
}

function forceEdit(id) {
    if(!tempEditData) return;
    
    const lesson = lessons.find(l => l.id === id);
    const editAllFuture = tempEditData.editAllFuture;
    
    if(editAllFuture && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.firstName = tempEditData.firstName;
            l.lastName = tempEditData.lastName;
            l.day = tempEditData.day;
            l.time = tempEditData.time;
            l.duration = tempEditData.duration;
        });
        toast("Updated all lessons in series (with conflict)");
    } else {
        lesson.firstName = tempEditData.firstName;
        lesson.lastName = tempEditData.lastName;
        lesson.day = tempEditData.day;
        lesson.time = tempEditData.time;
        lesson.duration = tempEditData.duration;
        toast("Lesson updated (with conflict)");
    }
    
    tempEditData = null;
    closeModal();
    render();
}

function deleteLesson(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    
    if(lesson.isRecurring && lesson.seriesId) {
        const html = "<h3 class='modal-title' style='color: var(--rose-500);'>Delete Recurring Lesson?</h3>" +
            "<p class='mb-4'>This is a recurring lesson for <strong>" + name + "</strong>.</p>" +
            "<p class='text-sm mb-4' style='color: var(--stone-500);'>What would you like to delete?</p>" +
            "<button onclick='deleteOnlyThis(" + id + ")' class='modal-btn modal-btn-warning'>" +
            "Delete Only This Lesson<br><span style='font-size: 0.8rem; opacity: 0.9;'>Remove just this single occurrence</span>" +
            "</button>" +
            "<button onclick='deleteAllInSeries(\"" + lesson.seriesId + "\")' class='modal-btn modal-btn-danger'>" +
            "Delete All Lessons in Series<br><span style='font-size: 0.8rem; opacity: 0.9;'>Remove all lessons for this student</span>" +
            "</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
        
        modal(html);
    } else {
        const html = "<h3 class='modal-title' style='color: var(--rose-500);'>Delete Lesson?</h3>" +
            "<p class='mb-4'>Delete lesson for <strong>" + name + "</strong>?</p>" +
            "<button onclick='confirmDelete(" + id + ")' class='modal-btn modal-btn-danger'>Yes, Delete</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
        
        modal(html);
    }
}

function deleteOnlyThis(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    lessons = lessons.filter(l => l.id !== id);
    closeModal();
    render();
    toast("Deleted one lesson for " + name);
}

function deleteAllInSeries(seriesId) {
    const firstLesson = lessons.find(l => l.seriesId === seriesId);
    const name = firstLesson.firstName + " " + firstLesson.lastName;
    const count = lessons.filter(l => l.seriesId === seriesId).length;
    lessons = lessons.filter(l => l.seriesId !== seriesId);
    closeModal();
    render();
    toast("Deleted " + count + " lessons for " + name);
}

function confirmDelete(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    lessons = lessons.filter(l => l.id !== id);
    closeModal();
    render();
    toast("Deleted: " + name);
}

function showAddModal() {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    let studentOptions = "<option value=''>-- Select Student --</option>";
    students.forEach(s => {
        studentOptions += "<option value='" + s.firstName + "|" + s.lastName + "'>" + s.firstName + " " + s.lastName + "</option>";
    });
    studentOptions += "<option value='new'>+ Add New Student</option>";
    
    const html = "<h3 class='modal-title'>Add New Lesson</h3>" +
        "<label class='form-label'>Student</label>" +
        "<select id='studentSelect' class='form-select' onchange='handleStudentSelect()'>" +
        studentOptions +
        "</select>" +
        "<div id='nameFields' style='display:none;'>" +
        "<label class='form-label'>First Name</label>" +
        "<input id='newFirst' placeholder='First Name' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input id='newLast' placeholder='Last Name' class='form-input'>" +
        "</div>" +
        "<label class='form-label'>Day</label>" +
        "<select id='newDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='newTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='newDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option><option value='45'>45 minutes</option><option value='60' selected>60 minutes</option></select>" +
        "<label class='form-checkbox'>" +
        "<input type='checkbox' id='newRecurring' checked onchange='toggleEndDate()'>" +
        "<span>Recurring weekly lesson</span>" +
        "</label>" +
        "<div id='endDateSection'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='date' id='endDate' class='form-input'>" +
        "<p class='text-xs' style='color: var(--stone-400); margin-top: -0.75rem; margin-bottom: 1rem;'>Leave blank to repeat indefinitely</p>" +
        "</div>" +
        "<button onclick='saveNew()' class='modal-btn modal-btn-success'>Add Lesson</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function handleStudentSelect() {
    const select = document.getElementById('studentSelect');
    const nameFields = document.getElementById('nameFields');
    const firstInput = document.getElementById('newFirst');
    const lastInput = document.getElementById('newLast');
    
    if(select.value === 'new') {
        nameFields.style.display = 'block';
        firstInput.value = '';
        lastInput.value = '';
        firstInput.readOnly = false;
        lastInput.readOnly = false;
    } else if(select.value === '') {
        nameFields.style.display = 'none';
        firstInput.value = '';
        lastInput.value = '';
    } else {
        const [firstName, lastName] = select.value.split('|');
        nameFields.style.display = 'block';
        firstInput.value = firstName;
        lastInput.value = lastName;
        firstInput.readOnly = true;
        lastInput.readOnly = true;
    }
}

function toggleEndDate() {
    const recurring = document.getElementById('newRecurring').checked;
    const endDateSection = document.getElementById('endDateSection');
    if(endDateSection) {
        endDateSection.style.display = recurring ? 'block' : 'none';
    }
}

function saveNew() {
    const studentSelect = document.getElementById('studentSelect');
    const firstName = document.getElementById('newFirst').value.trim();
    const lastName = document.getElementById('newLast').value.trim();
    
    if(!studentSelect.value) {
        toast("Please select a student");
        return;
    }
    
    if(!firstName || !lastName) {
        toast("Please enter student name");
        return;
    }
    
    const newDay = parseInt(document.getElementById('newDay').value);
    const newTime = document.getElementById('newTime').value;
    const newDuration = parseInt(document.getElementById('newDuration').value);
    const isRecurring = document.getElementById('newRecurring').checked;
    
    tempNewData = {
        firstName: firstName,
        lastName: lastName,
        day: newDay,
        time: newTime,
        duration: newDuration,
        isRecurring: isRecurring,
        endDate: document.getElementById('endDate') ? document.getElementById('endDate').value : ''
    };
    
    const conflicts = checkConflict(newDay, newTime, newDuration, null);
    
    if(conflicts.length > 0) {
        closeModal();
        const conflictList = conflicts.map(c => {
            const name = c.firstName + " " + c.lastName;
            const endTime = addMinutes(c.time, c.duration);
            const dateInfo = getDateForLesson(c);
            return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
                   "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
                   c.time + " to " + endTime + " (" + c.duration + " min)</div>";
        }).join('');
        
        const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
            "<p class='mb-4'>This lesson conflicts with:</p>" +
            "<div class='conflict-list'>" + conflictList + "</div>" +
            "<button onclick='forceNew()' class='modal-btn modal-btn-warning'>Add Anyway</button>" +
            "<button onclick='showAddModal()' class='modal-btn modal-btn-secondary'>Go Back</button>";
        
        modal(html);
        return;
    }
    
    const newLesson = {
        id: nextId++,
        firstName: firstName,
        lastName: lastName,
        day: newDay,
        time: newTime,
        duration: newDuration,
        week: currentWeek
    };
    
    lessons.push(newLesson);
    
    if(isRecurring) {
        newLesson.isRecurring = true;
        newLesson.seriesId = "series-" + nextSeriesId++;
        
        const endDateInput = document.getElementById('endDate');
        const endDateValue = endDateInput ? endDateInput.value : '';
        
        if(endDateValue) {
            const endDate = new Date(endDateValue);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: newDay,
                    time: newTime,
                    duration: newDuration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
            toast("Lesson added! Created " + (weeksToCreate + 1) + " lessons until " + endDate.toLocaleDateString());
        } else {
            for(let w = 1; w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: newDay,
                    time: newTime,
                    duration: newDuration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
            toast("Lesson added! (Recurring for 52 weeks)");
        }
    } else {
        toast("Lesson added!");
    }
    
    closeModal();
    render();
}

function forceNew() {
    if(!tempNewData) return;
    
    const newLesson = {
        id: nextId++,
        firstName: tempNewData.firstName,
        lastName: tempNewData.lastName,
        day: tempNewData.day,
        time: tempNewData.time,
        duration: tempNewData.duration,
        week: currentWeek
    };
    
    lessons.push(newLesson);
    
    if(tempNewData.isRecurring) {
        newLesson.isRecurring = true;
        newLesson.seriesId = "series-" + nextSeriesId++;
        
        if(tempNewData.endDate) {
            const endDate = new Date(tempNewData.endDate);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: tempNewData.day,
                    time: tempNewData.time,
                    duration: tempNewData.duration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
        } else {
            for(let w = 1; w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: tempNewData.day,
                    time: tempNewData.time,
                    duration: tempNewData.duration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
        }
    }
    
    tempNewData = null;
    closeModal();
    render();
    toast("Lesson added (with conflict)");
}

function modal(html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modal').classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function showBlockTimeModal() {
    const html = "<h3 class='modal-title'>Block Time Slot</h3>" +
        "<p class='modal-subtitle'>Mark times when you're unavailable</p>" +
        "<label class='form-label'>Day</label>" +
        "<select id='blockDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='blockTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='blockDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option>" +
        "<option value='60' selected>1 hour</option>" +
        "<option value='90'>1.5 hours</option>" +
        "<option value='120'>2 hours</option>" +
        "<option value='180'>3 hours</option>" +
        "<option value='240'>4 hours</option>" +
        "</select>" +
        "<label class='form-label'>Reason</label>" +
        "<input id='blockReason' placeholder='e.g., Lunch, Meeting' class='form-input'>" +
        "<label class='form-label'>Repeat Options</label>" +
        "<select id='blockRepeatType' class='form-select' onchange='toggleBlockEndDate()'>" +
        "<option value='none'>This day only (one time)</option>" +
        "<option value='weekly'>Every week on this day</option>" +
        "<option value='daily'>Every day (all 7 days)</option>" +
        "</select>" +
        "<div id='blockEndDateSection' style='display:none;'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional - leave blank for indefinitely)</span></label>" +
        "<input type='date' id='blockEndDate' class='form-input'>" +
        "</div>" +
        "<button onclick='saveBlockTime()' class='modal-btn modal-btn-warning'>Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function toggleBlockEndDate() {
    const repeatType = document.getElementById('blockRepeatType');
    const endDateSection = document.getElementById('blockEndDateSection');
    if(repeatType && endDateSection) {
        endDateSection.style.display = (repeatType.value !== 'none') ? 'block' : 'none';
    }
}

function saveBlockTime() {
    const blockDay = parseInt(document.getElementById('blockDay').value);
    const blockTime = document.getElementById('blockTime').value;
    const blockDuration = parseInt(document.getElementById('blockDuration').value);
    const blockReason = document.getElementById('blockReason').value || 'Unavailable';
    const repeatType = document.getElementById('blockRepeatType').value;
    
    applyBlockTime(blockDay, blockTime, blockDuration, blockReason, repeatType);
}

function applyBlockTime(blockDay, blockTime, blockDuration, blockReason, repeatType) {
    const block = {
        id: nextBlockId++,
        day: blockDay,
        time: blockTime,
        duration: blockDuration,
        reason: blockReason,
        week: currentWeek
    };
    
    blockedTimes.push(block);
    
    if(repeatType === 'daily' || repeatType === 'weekly') {
        const endDateInput = document.getElementById('blockEndDate');
        const endDateValue = endDateInput ? endDateInput.value : '';
        
        if(endDateValue) {
            const endDate = new Date(endDateValue);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            if(repeatType === 'daily') {
                for(let w = 0; w <= weeksToCreate && w <= 52; w++) {
                    for(let d = 0; d < 7; d++) {
                        if(w === 0 && d === blockDay) continue;
                        blockedTimes.push({
                            id: nextBlockId++,
                            day: d,
                            time: blockTime,
                            duration: blockDuration,
                            reason: blockReason,
                            week: currentWeek + w
                        });
                    }
                }
            } else {
                for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                    blockedTimes.push({
                        id: nextBlockId++,
                        day: blockDay,
                        time: blockTime,
                        duration: blockDuration,
                        reason: blockReason,
                        week: currentWeek + w
                    });
                }
            }
        } else {
            if(repeatType === 'daily') {
                for(let w = 0; w <= 52; w++) {
                    for(let d = 0; d < 7; d++) {
                        if(w === 0 && d === blockDay) continue;
                        blockedTimes.push({
                            id: nextBlockId++,
                            day: d,
                            time: blockTime,
                            duration: blockDuration,
                            reason: blockReason,
                            week: currentWeek + w
                        });
                    }
                }
            } else {
                for(let w = 1; w <= 52; w++) {
                    blockedTimes.push({
                        id: nextBlockId++,
                        day: blockDay,
                        time: blockTime,
                        duration: blockDuration,
                        reason: blockReason,
                        week: currentWeek + w
                    });
                }
            }
        }
    }
    
    toast("Time blocked: " + blockReason);
    closeModal();
    render();
}

function showBlockDetails(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) {
        toast('Error: Block not found');
        return;
    }
    
    const endTime = addMinutes(block.time, block.duration);
    const isPast = isInPast(block.week, block.day);
    const dateInfo = getDateForLesson(block);
    
    // Check if this is a default/system block
    const isSystemBlock = block.reason === 'Closed' || block.reason === 'Weekend' || block.reason === 'Lunch';
    
    // Find all matching blocks (same time, duration, reason - could be weekly or daily pattern)
    const matchingWeekly = blockedTimes.filter(b => 
        b.time === block.time && 
        b.duration === block.duration && 
        b.reason === block.reason && 
        b.day === block.day &&
        !isInPast(b.week, b.day)
    );
    
    const matchingDaily = blockedTimes.filter(b => 
        b.time === block.time && 
        b.duration === block.duration && 
        b.reason === block.reason &&
        !isInPast(b.week, b.day)
    );
    
    const hasWeeklyRecurrence = matchingWeekly.length > 1;
    const hasDailyRecurrence = matchingDaily.length > matchingWeekly.length;
    
    let html = "<h3 class='modal-title' style='color: var(--stone-600);'>🚫 Blocked Time</h3>";
    
    if(isPast) {
        html += "<div class='info-box info-box-info'>📅 Past block (read-only)</div>";
    }
    
    // Show block details
    html += "<div class='mb-4'>" +
        "<div class='detail-row'><span class='detail-label'>Day</span><span class='detail-value'>" + days[block.day] + ", " + dateInfo + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Time</span><span class='detail-value'>" + block.time + " - " + endTime + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Duration</span><span class='detail-value'>" + block.duration + " minutes</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Reason</span><span class='detail-value'>" + block.reason + "</span></div>" +
        "</div>";
    
    if(hasWeeklyRecurrence || hasDailyRecurrence) {
        html += "<div class='recurring-badge' style='margin-bottom: 1rem;'>🔁 Recurring block</div>";
    }
    
    if(isSystemBlock && !isPast) {
        html += "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
            "<strong>Default Time Block</strong><br>" +
            "<span style='font-size: 0.8rem;'>This is a default blocked time. You can unblock it to allow scheduling.</span>" +
            "</div>";
    }
    
    if(!isPast) {
        html += "<p class='text-sm mb-4' style='color: var(--stone-500);'>Would you like to unblock this time?</p>";
        
        if(hasDailyRecurrence && matchingDaily.length > matchingWeekly.length) {
            // Has daily pattern (all 7 days)
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-primary'>" +
                "Unblock This Instance Only<br><span style='font-size: 0.8rem; opacity: 0.9;'>Just " + days[block.day] + ", " + dateInfo + "</span>" +
                "</button>" +
                "<button onclick='unblockAllWeekly(" + blockId + ")' class='modal-btn modal-btn-warning'>" +
                "Unblock Every " + days[block.day] + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingWeekly.length + " future instances at " + block.time + ")</span>" +
                "</button>" +
                "<button onclick='unblockAllDaily(" + blockId + ")' class='modal-btn modal-btn-danger'>" +
                "Unblock Every Day at " + block.time + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingDaily.length + " future instances, all days)</span>" +
                "</button>";
        } else if(hasWeeklyRecurrence) {
            // Has weekly pattern only
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-primary'>" +
                "Unblock This Instance Only<br><span style='font-size: 0.8rem; opacity: 0.9;'>Just " + days[block.day] + ", " + dateInfo + "</span>" +
                "</button>" +
                "<button onclick='unblockAllWeekly(" + blockId + ")' class='modal-btn modal-btn-danger'>" +
                "Unblock Every " + days[block.day] + " at " + block.time + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingWeekly.length + " future instances)</span>" +
                "</button>";
        } else {
            // Single instance
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-danger'>Yes, Unblock This Time</button>";
        }
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function unblockAllWeekly(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) return;
    
    const countBefore = blockedTimes.length;
    
    // Remove all blocks with same day, time, duration, and reason
    blockedTimes = blockedTimes.filter(b => 
        !(b.time === block.time && 
          b.duration === block.duration && 
          b.reason === block.reason && 
          b.day === block.day)
    );
    
    const removed = countBefore - blockedTimes.length;
    closeModal();
    saveData();
    render();
    toast("Unblocked " + removed + " instances on " + days[block.day] + "s");
}

function unblockAllDaily(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) return;
    
    const countBefore = blockedTimes.length;
    
    // Remove all blocks with same time, duration, and reason (any day)
    blockedTimes = blockedTimes.filter(b => 
        !(b.time === block.time && 
          b.duration === block.duration && 
          b.reason === block.reason)
    );
    
    const removed = countBefore - blockedTimes.length;
    closeModal();
    saveData();
    render();
    toast("Unblocked " + removed + " instances at " + block.time);
}

function confirmUnblockTime(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    blockedTimes = blockedTimes.filter(b => b.id !== blockId);
    closeModal();
    saveData();
    render();
    toast("Time unblocked: " + block.reason);
}

function handleCellClick(day, time) {
    if(isInPast(currentWeek, day)) return;
    
    const hour = parseInt(time.split(':')[0]);
    const cellStartMinutes = hour * 60;
    const cellEndMinutes = (hour + 1) * 60;
    
    const hasLessons = lessons.some(l => l.day === day && l.week === currentWeek && l.time.startsWith(time.split(':')[0]));
    
    // Check if any block covers this cell (not just starts in this hour)
    const hasBlocks = blockedTimes.some(b => {
        if(b.day !== day || b.week !== currentWeek) return false;
        const blockStartHour = parseInt(b.time.split(':')[0]);
        const blockStartMinutes = parseInt(b.time.split(':')[1]);
        const blockTotalStartMinutes = blockStartHour * 60 + blockStartMinutes;
        const blockTotalEndMinutes = blockTotalStartMinutes + b.duration;
        // Block overlaps this cell if it starts before cell ends and ends after cell starts
        return blockTotalStartMinutes < cellEndMinutes && blockTotalEndMinutes > cellStartMinutes;
    });
    
    if(!hasLessons && !hasBlocks) {
        showCellActionChoice(day, time);
    }
}

function showCellActionChoice(day, time) {
    const dayName = days[day];
    const html = "<h3 class='modal-title'>What would you like to do?</h3>" +
        "<p class='mb-4' style='color: var(--stone-500);'>For <strong>" + dayName + " at " + time + "</strong></p>" +
        "<button onclick='showAddModalWithTime(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-success'>📅 Add Lesson</button>" +
        "<button onclick='showQuickBlockModal(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-warning'>🚫 Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function showAddModalWithTime(day, time) {
    closeModal();
    setTimeout(() => {
        showAddModal();
        document.getElementById('newDay').value = day;
        document.getElementById('newTime').value = time;
    }, 100);
}

function showQuickBlockModal(day, time) {
    const dayName = days[day];
    const html = "<h3 class='modal-title'>Block This Time?</h3>" +
        "<p class='mb-4' style='color: var(--stone-500);'>Block <strong>" + dayName + " at " + time + "</strong>?</p>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='quickBlockDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option>" +
        "<option value='60' selected>1 hour</option>" +
        "<option value='90'>1.5 hours</option>" +
        "<option value='120'>2 hours</option>" +
        "</select>" +
        "<label class='form-label'>Reason <span class='form-label-optional'>(Optional)</span></label>" +
        "<input id='quickBlockReason' placeholder='e.g., Lunch' class='form-input'>" +
        "<label class='form-label'>Apply to</label>" +
        "<select id='quickBlockRepeat' class='form-select'>" +
        "<option value='once'>This day only (one time)</option>" +
        "<option value='weekly'>Every week on " + dayName + "</option>" +
        "<option value='daily'>Every day at " + time + " (all 7 days, all weeks)</option>" +
        "</select>" +
        "<button onclick='saveQuickBlock(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-warning'>Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveQuickBlock(day, time) {
    const duration = parseInt(document.getElementById('quickBlockDuration').value);
    const reason = document.getElementById('quickBlockReason').value || 'Unavailable';
    const repeatType = document.getElementById('quickBlockRepeat').value;
    
    if(repeatType === 'daily') {
        // Block all 7 days at this time for all weeks
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            for(let d = 0; d < 7; d++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: d,
                    time: time,
                    duration: duration,
                    reason: reason,
                    week: week
                });
            }
        }
        toast("Time blocked: " + reason + " (all days, all weeks)");
    } else if(repeatType === 'weekly') {
        // Block this day for all weeks
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            blockedTimes.push({
                id: nextBlockId++,
                day: day,
                time: time,
                duration: duration,
                reason: reason,
                week: week
            });
        }
        toast("Time blocked: " + reason + " (every " + days[day] + ")");
    } else {
        // Block only this one instance
        blockedTimes.push({
            id: nextBlockId++,
            day: day,
            time: time,
            duration: duration,
            reason: reason,
            week: currentWeek
        });
        toast("Time blocked: " + reason);
    }
    
    closeModal();
    render();
}

function applyQuickBlock(day, time, duration, reason, recurring) {
    if(recurring) {
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            blockedTimes.push({
                id: nextBlockId++,
                day: day,
                time: time,
                duration: duration,
                reason: reason,
                week: week
            });
        }
        toast("Time blocked: " + reason + " (all weeks)");
    } else {
        blockedTimes.push({
            id: nextBlockId++,
            day: day,
            time: time,
            duration: duration,
            reason: reason,
            week: currentWeek
        });
        toast("Time blocked: " + reason);
    }
    
    closeModal();
    render();
}

function showStudentsModal() {
    const studentList = getUniqueStudents();
    const activeStudents = studentList.filter(s => !s.retired);
    const retiredStudents = studentList.filter(s => s.retired);
    
    let html = "<h3 class='modal-title'>👥 Student Management</h3>";
    html += "<p class='modal-subtitle'>Manage your students and their schedules</p>";
    
    html += "<button onclick='showAddStudentModal()' class='modal-btn modal-btn-success'>+ Add New Student</button>";
    
    if(studentList.length === 0) {
        html += "<p style='color: var(--stone-500);'>No students yet. Add a student to get started.</p>";
    } else {
        html += "<div class='scroll-container' style='margin-top: 1rem;'>";
        
        if(activeStudents.length > 0) {
            activeStudents.forEach(student => {
                html += "<div class='student-card'>" +
                    "<div class='student-card-header'>" +
                    "<div>" +
                    "<div class='student-name-large'>" + student.firstName + " " + student.lastName + "</div>" +
                    "<div class='student-meta'>" + student.lessonCount + " total lessons • " + student.weeklyLessons + " this week</div>" +
                    "</div>" +
                    "<div class='student-actions'>" +
                    "<button onclick='viewStudentSchedule(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--teal-500); color: white;'>View</button>" +
                    "<button onclick='retireStudent(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--coral-500); color: white;'>Retire</button>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            });
        }
        
        if(retiredStudents.length > 0) {
            html += "<div class='section-divider'><div class='section-title'>Retired Students</div></div>";
            retiredStudents.forEach(student => {
                html += "<div class='student-card' style='opacity: 0.6; border-color: var(--stone-300);'>" +
                    "<div class='student-card-header'>" +
                    "<div>" +
                    "<div class='student-name-large' style='color: var(--stone-500);'>" + student.firstName + " " + student.lastName + " <span class='text-xs'>(Retired)</span></div>" +
                    "<div class='student-meta'>" + student.lessonCount + " total lessons</div>" +
                    "</div>" +
                    "<div class='student-actions'>" +
                    "<button onclick='viewStudentSchedule(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--stone-500); color: white;'>View</button>" +
                    "<button onclick='unretireStudent(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--emerald-500); color: white;'>Reactivate</button>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            });
        }
        
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function getUniqueStudents() {
    const studentMap = new Map();
    
    studentProfiles.forEach(profile => {
        const key = profile.firstName + " " + profile.lastName;
        studentMap.set(key, {
            firstName: profile.firstName,
            lastName: profile.lastName,
            lessonCount: 0,
            weeklyLessons: 0,
            retired: profile.retired || false
        });
    });
    
    lessons.forEach(lesson => {
        const key = lesson.firstName + " " + lesson.lastName;
        if(!studentMap.has(key)) {
            studentMap.set(key, {
                firstName: lesson.firstName,
                lastName: lesson.lastName,
                lessonCount: 0,
                weeklyLessons: 0,
                retired: false
            });
        }
        const student = studentMap.get(key);
        student.lessonCount++;
        if(lesson.week === currentWeek) {
            student.weeklyLessons++;
        }
    });
    
    return Array.from(studentMap.values()).sort((a, b) => {
        if(a.retired !== b.retired) return a.retired ? 1 : -1;
        return (a.firstName + a.lastName).localeCompare(b.firstName + b.lastName);
    });
}

function viewStudentSchedule(firstName, lastName) {
    const studentLessons = lessons.filter(l => l.firstName === firstName && l.lastName === lastName);
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName, dob: '', grade: '', school: '', homeAddress: '', guardianName: '', guardianPhone: '', guardianEmail: '', guardian2Name: '', guardian2Phone: '', guardian2Email: '', photo: '', retired: false };
    }
    
    let html = "<h3 class='modal-title'>👤 " + firstName + " " + lastName + "</h3>";
    
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='scheduleStudentLesson(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>📅 Schedule</button>" +
        "<button onclick='editStudentProfile(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>✏️ Edit</button>" +
        "</div>";
    
    html += "<div class='profile-section'>" +
        "<div class='profile-header'>";
    
    if(profile.photo) {
        html += "<img src='" + profile.photo + "' class='profile-photo' alt='Student photo'>";
    } else {
        html += "<div class='profile-photo-placeholder'>No photo</div>";
    }
    
    html += "<div style='flex: 1;'>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.5rem;'>Family Code</div>" +
        "<div class='family-code-display'>" + (profile.familyCode || 'Not set') + "</div>" +
        "</div></div>";
    
    html += "<div class='detail-row'><span class='detail-label'>Date of Birth</span><span class='detail-value'>" + (profile.dob || 'Not set') + "</span></div>";
    if(profile.grade) html += "<div class='detail-row'><span class='detail-label'>Grade</span><span class='detail-value'>" + profile.grade + "</span></div>";
    if(profile.school) html += "<div class='detail-row'><span class='detail-label'>School</span><span class='detail-value'>" + profile.school + "</span></div>";
    if(profile.guardianName) html += "<div class='detail-row'><span class='detail-label'>Guardian</span><span class='detail-value'>" + profile.guardianName + "</span></div>";
    if(profile.guardianPhone) html += "<div class='detail-row'><span class='detail-label'>Phone</span><span class='detail-value'>" + profile.guardianPhone + "</span></div>";
    
    html += "</div>";
    
    html += "<div class='section-title'>Schedule (" + studentLessons.length + " lessons)</div>";
    
    if(studentLessons.length === 0) {
        html += "<p style='color: var(--stone-500);'>No lessons scheduled</p>";
    } else {
        html += "<div class='scroll-container'>";
        
        const weekGroups = {};
        studentLessons.forEach(lesson => {
            if(!weekGroups[lesson.week]) weekGroups[lesson.week] = [];
            weekGroups[lesson.week].push(lesson);
        });
        
        Object.keys(weekGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(week => {
            const weekNum = parseInt(week);
            let weekLabel = weekNum === 0 ? "This Week" : 
                           weekNum === 1 ? "Next Week" :
                           weekNum > 0 ? (weekNum + " Weeks Ahead") :
                           weekNum === -1 ? "Last Week" :
                           (Math.abs(weekNum) + " Weeks Ago");
            
            html += "<div style='margin-bottom: 0.75rem;'>" +
                "<div style='font-weight: 600; font-size: 0.8rem; color: var(--stone-700); margin-bottom: 0.25rem;'>" + weekLabel + "</div>";
            
            weekGroups[week].forEach(lesson => {
                const dateInfo = getDateForLesson(lesson);
                html += "<div style='font-size: 0.8rem; padding-left: 0.75rem; border-left: 2px solid var(--teal-400); margin-bottom: 0.25rem; color: var(--stone-600);'>" +
                    days[lesson.day] + ", " + dateInfo + " at " + lesson.time + " (" + lesson.duration + " min)" +
                    (lesson.isRecurring ? " 🔁" : "") +
                    "</div>";
            });
            html += "</div>";
        });
        
        html += "</div>";
    }
    
    html += "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Back to Students</button>";
    
    modal(html);
}

function editStudentProfile(firstName, lastName) {
    // Reset temp photo data
    tempPhotoData = null;
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName, dob: '', grade: '', school: '', homeAddress: '', guardianName: '', guardianPhone: '', guardianEmail: '', guardian2Name: '', guardian2Phone: '', guardian2Email: '', photo: '', retired: false };
    }
    
    // Photo preview HTML
    let photoHtml = "";
    if(profile.photo) {
        photoHtml = "<div class='photo-upload-preview'>" +
            "<img src='" + profile.photo + "' id='photoPreview' class='photo-preview-img'>" +
            "<button type='button' onclick='removeStudentPhoto(\"" + firstName + "\",\"" + lastName + "\")' class='photo-remove-btn'>✕ Remove</button>" +
            "</div>";
    } else {
        photoHtml = "<div class='photo-upload-preview'>" +
            "<div id='photoPreview' class='photo-placeholder'>📷<br><span style='font-size: 0.75rem;'>No photo</span></div>" +
            "</div>";
    }
    
    let html = "<h3 class='modal-title'>✏️ Edit Student Info</h3>" +
        "<p class='modal-subtitle'>" + firstName + " " + lastName + "</p>" +
        
        // Photo upload section
        "<div class='photo-upload-section'>" +
        photoHtml +
        "<div class='photo-upload-controls'>" +
        "<label class='form-label'>Student Photo</label>" +
        "<input type='file' id='photoInput' accept='image/*' onchange='previewStudentPhoto(this)' class='form-input' style='padding: 0.5rem;'>" +
        "<p style='font-size: 0.7rem; color: var(--stone-400); margin-top: 0.25rem;'>JPG, PNG, or GIF. Max 1MB recommended.</p>" +
        "</div>" +
        "</div>" +
        "<div class='section-divider'></div>" +
        
        "<label class='form-label'>Date of Birth</label>" +
        "<input type='date' id='editDob' value='" + (profile.dob || '') + "' class='form-input' oninput='generateEditFamilyCode(\"" + lastName + "\")'>" +
        "<label class='form-label'>Grade <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editGrade' value='" + (profile.grade || '') + "' placeholder='5th Grade, Junior, etc.' class='form-input'>" +
        "<label class='form-label'>School <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editSchool' value='" + (profile.school || '') + "' placeholder='Lincoln Elementary' class='form-input'>" +
        "<div class='section-divider'></div>" +
        "<label class='form-label'>Family Code</label>" +
        "<input type='text' id='editFamilyCode' value='" + (profile.familyCode || '') + "' placeholder='SMITH2013' class='form-input' style='font-family: monospace; text-transform: uppercase;'>" +
        "<div class='section-divider'></div>" +
        "<div class='section-title'>Parent/Guardian</div>" +
        "<label class='form-label'>Name</label>" +
        "<input type='text' id='editGuardianName' value='" + (profile.guardianName || '') + "' placeholder='John Doe' class='form-input'>" +
        "<label class='form-label'>Phone</label>" +
        "<input type='tel' id='editGuardianPhone' value='" + (profile.guardianPhone || '') + "' placeholder='(555) 123-4567' class='form-input'>" +
        "<label class='form-label'>Email</label>" +
        "<input type='email' id='editGuardianEmail' value='" + (profile.guardianEmail || '') + "' placeholder='parent@example.com' class='form-input'>" +
        "<button onclick='saveStudentProfile(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary'>Save</button>" +
        "<button onclick='viewStudentSchedule(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

// Temporary storage for photo during editing
let tempPhotoData = null;

function previewStudentPhoto(input) {
    const file = input.files[0];
    if(!file) return;
    
    // Check file size (warn if over 1MB)
    if(file.size > 1024 * 1024) {
        if(!confirm('This image is larger than 1MB and may slow down the app. Continue anyway?')) {
            input.value = '';
            return;
        }
    }
    
    // Check file type
    if(!file.type.startsWith('image/')) {
        toast('Please select an image file');
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        tempPhotoData = e.target.result;
        
        const preview = document.getElementById('photoPreview');
        if(preview) {
            // Replace placeholder or update existing image
            const container = preview.parentElement;
            container.innerHTML = "<img src='" + tempPhotoData + "' id='photoPreview' class='photo-preview-img'>" +
                "<button type='button' onclick='clearPhotoPreview()' class='photo-remove-btn'>✕ Remove</button>";
        }
    };
    reader.readAsDataURL(file);
}

function clearPhotoPreview() {
    tempPhotoData = '';  // Empty string means remove photo
    const preview = document.getElementById('photoPreview');
    if(preview) {
        const container = preview.parentElement;
        container.innerHTML = "<div id='photoPreview' class='photo-placeholder'>📷<br><span style='font-size: 0.75rem;'>No photo</span></div>";
    }
    const input = document.getElementById('photoInput');
    if(input) input.value = '';
}

function removeStudentPhoto(firstName, lastName) {
    tempPhotoData = '';  // Mark for removal
    clearPhotoPreview();
}

function generateEditFamilyCode(lastName) {
    const dob = document.getElementById('editDob').value;
    if(lastName && dob) {
        const year = dob.split('-')[0];
        document.getElementById('editFamilyCode').value = lastName.toUpperCase() + year;
    }
}

function saveStudentProfile(firstName, lastName) {
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName };
        studentProfiles.push(profile);
    }
    
    profile.dob = document.getElementById('editDob').value;
    profile.grade = document.getElementById('editGrade').value;
    profile.school = document.getElementById('editSchool').value;
    profile.familyCode = document.getElementById('editFamilyCode').value.trim().toUpperCase();
    profile.guardianName = document.getElementById('editGuardianName').value;
    profile.guardianPhone = document.getElementById('editGuardianPhone').value;
    profile.guardianEmail = document.getElementById('editGuardianEmail').value;
    
    // Handle photo update
    if(tempPhotoData !== null) {
        profile.photo = tempPhotoData;  // Could be base64 data or empty string to remove
        tempPhotoData = null;  // Reset temp storage
    }
    
    toast("Profile updated!");
    viewStudentSchedule(firstName, lastName);
}

function showAddStudentModal() {
    const html = "<h3 class='modal-title'>➕ Add New Student</h3>" +
        "<label class='form-label'>First Name</label>" +
        "<input type='text' id='newStudentFirst' placeholder='Emma' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input type='text' id='newStudentLast' placeholder='Smith' class='form-input' oninput='generateFamilyCode()'>" +
        "<label class='form-label'>Date of Birth</label>" +
        "<input type='date' id='newStudentDob' class='form-input' oninput='generateFamilyCode()'>" +
        "<label class='form-label'>Family Code</label>" +
        "<input type='text' id='newStudentFamilyCode' placeholder='SMITH2013' class='form-input' style='font-family: monospace; text-transform: uppercase;'>" +
        "<div class='section-divider'></div>" +
        "<div class='section-title'>Parent/Guardian</div>" +
        "<label class='form-label'>Name</label>" +
        "<input type='text' id='newStudentGuardian' placeholder='John Doe' class='form-input'>" +
        "<label class='form-label'>Phone</label>" +
        "<input type='tel' id='newStudentPhone' placeholder='(555) 123-4567' class='form-input'>" +
        "<label class='form-label'>Email</label>" +
        "<input type='email' id='newStudentEmail' placeholder='parent@example.com' class='form-input'>" +
        "<button onclick='saveNewStudent()' class='modal-btn modal-btn-success'>Create Student</button>" +
        "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function generateFamilyCode() {
    const lastName = document.getElementById('newStudentLast').value.trim().toUpperCase();
    const dob = document.getElementById('newStudentDob').value;
    
    if(lastName && dob) {
        const year = dob.split('-')[0];
        document.getElementById('newStudentFamilyCode').value = lastName + year;
    }
}

function saveNewStudent() {
    const firstName = document.getElementById('newStudentFirst').value.trim();
    const lastName = document.getElementById('newStudentLast').value.trim();
    
    if(!firstName || !lastName) {
        toast("First and last name are required");
        return;
    }
    
    const exists = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(exists) {
        toast("Student already exists");
        return;
    }
    
    const familyCode = document.getElementById('newStudentFamilyCode').value.trim().toUpperCase();
    if(!familyCode) {
        toast("Family code is required");
        return;
    }
    
    const codeExists = studentProfiles.find(p => p.familyCode === familyCode);
    if(codeExists) {
        toast("Family code already in use");
        return;
    }
    
    studentProfiles.push({
        firstName,
        lastName,
        familyCode,
        dob: document.getElementById('newStudentDob').value,
        guardianName: document.getElementById('newStudentGuardian').value.trim(),
        guardianPhone: document.getElementById('newStudentPhone').value.trim(),
        guardianEmail: document.getElementById('newStudentEmail').value.trim(),
        photo: "",
        retired: false
    });
    
    toast("Student " + firstName + " " + lastName + " added");
    showStudentsModal();
}

function scheduleStudentLesson(firstName, lastName) {
    const html = "<h3 class='modal-title'>📅 Schedule Lesson</h3>" +
        "<p class='modal-subtitle'>For: <strong>" + firstName + " " + lastName + "</strong></p>" +
        "<label class='form-label'>Day</label>" +
        "<select id='newDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='newTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='newDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option><option value='45'>45 minutes</option><option value='60' selected>60 minutes</option></select>" +
        "<label class='form-checkbox'>" +
        "<input type='checkbox' id='newRecurring' checked onchange='toggleEndDate()'>" +
        "<span>Recurring weekly</span>" +
        "</label>" +
        "<div id='endDateSection'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='date' id='endDate' class='form-input'>" +
        "</div>" +
        "<input type='hidden' id='newFirst' value='" + firstName + "'>" +
        "<input type='hidden' id='newLast' value='" + lastName + "'>" +
        "<button onclick='saveNew()' class='modal-btn modal-btn-success'>Schedule</button>" +
        "<button onclick='viewStudentSchedule(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function getDateForLesson(lesson) {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (lesson.week * 7));
    const lessonDate = new Date(startOfWeek);
    lessonDate.setDate(startOfWeek.getDate() + lesson.day);
    return (lessonDate.getMonth() + 1) + '/' + lessonDate.getDate() + '/' + lessonDate.getFullYear();
}

function retireStudent(firstName, lastName) {
    const allLessons = lessons.filter(l => l.firstName === firstName && l.lastName === lastName);
    const futureLessons = allLessons.filter(l => l.week >= currentWeek);
    
    const html = "<h3 class='modal-title' style='color: var(--coral-500);'>Retire Student?</h3>" +
        "<p class='mb-4'>Retire <strong>" + firstName + " " + lastName + "</strong>?</p>" +
        "<div class='info-box info-box-warning'>" +
        "<p><strong>This will:</strong></p>" +
        "<p>• Remove " + futureLessons.length + " future lessons</p>" +
        "<p>• Keep past lessons as history</p>" +
        "<p>• Move student to 'Retired' section</p>" +
        "</div>" +
        "<div class='info-box info-box-success'>You can reactivate this student anytime.</div>" +
        "<button onclick='confirmRetireStudent(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-warning'>Retire Student</button>" +
        "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function confirmRetireStudent(firstName, lastName) {
    const beforeCount = lessons.length;
    lessons = lessons.filter(l => !(l.firstName === firstName && l.lastName === lastName && l.week >= currentWeek));
    const deletedCount = beforeCount - lessons.length;
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(!profile) {
        profile = { firstName, lastName, retired: true };
        studentProfiles.push(profile);
    } else {
        profile.retired = true;
    }
    
    toast("Retired " + firstName + " " + lastName + " (" + deletedCount + " lessons removed)");
    showStudentsModal();
    render();
}

function unretireStudent(firstName, lastName) {
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(profile) {
        profile.retired = false;
        toast(firstName + " " + lastName + " reactivated");
        showStudentsModal();
    }
}

// ============ STUDENT SWAP FUNCTIONS ============

function showMyLessonsForSwap() {
    if(!loggedInStudent) return;
    
    const firstName = loggedInStudent.firstName;
    const lastName = loggedInStudent.lastName;
    const fullName = firstName + " " + lastName;
    
    const myLessons = lessons.filter(l => 
        l.firstName === firstName && l.lastName === lastName && !isInPast(l.week, l.day)
    ).sort((a, b) => {
        if(a.week !== b.week) return a.week - b.week;
        if(a.day !== b.day) return a.day - b.day;
        return a.time.localeCompare(b.time);
    });
    
    const incomingRequests = swapRequests.filter(r => r.status === 'pending' && r.targetStudent === fullName);
    const outgoingPending = swapRequests.filter(r => r.status === 'pending' && r.requestingStudent === fullName);
    const awaitingTeacher = swapRequests.filter(r => r.status === 'student_agreed' && (r.requestingStudent === fullName || r.targetStudent === fullName));
    
    let html = "<h3 class='modal-title'>🔄 Request Swap</h3>" +
        "<p class='modal-subtitle'>Select one of your lessons to swap</p>";
    
    // Show swaps awaiting teacher approval
    if(awaitingTeacher.length > 0) {
        html += "<div class='info-box info-box-info' style='background: var(--teal-50); border-color: var(--teal-300);'>" +
            "<strong style='color: var(--teal-700);'>✋ " + awaitingTeacher.length + " Swap" + (awaitingTeacher.length > 1 ? "s" : "") + " Awaiting Teacher Approval</strong>" +
            "<p style='font-size: 0.8rem; margin-top: 0.25rem; color: var(--teal-600);'>Both students agreed. Waiting for teacher to approve.</p>" +
            "</div>";
    }
    
    if(incomingRequests.length > 0) {
        html += "<div class='info-box info-box-warning'>" +
            "<strong>⚠️ " + incomingRequests.length + " Swap Request" + (incomingRequests.length > 1 ? "s" : "") + " Waiting</strong>" +
            "</div>";
        
        incomingRequests.forEach(request => {
            const theirLesson = lessons.find(l => l.id === request.requestingLessonId);
            const myLesson = lessons.find(l => l.id === request.targetLessonId);
            if(!theirLesson || !myLesson) return;
            
            const theirName = formatNamePrivate(theirLesson.firstName, theirLesson.lastName);
            
            html += "<div class='swap-request-card'>" +
                "<div class='text-sm mb-2'><strong>" + theirName + "</strong> wants to swap:</div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Their: " + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</div>" +
                "<div class='swap-arrow'>⬍</div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Your: " + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</div>" +
                "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='approveSwapInPortal(" + request.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Accept</button>" +
                "<button onclick='declineSwapInPortal(" + request.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>" +
                "</div>";
        });
    }
    
    if(outgoingPending.length > 0) {
        html += "<div class='info-box info-box-info'>" +
            "📤 " + outgoingPending.length + " pending request" + (outgoingPending.length > 1 ? "s" : "") + " awaiting other student's response" +
            "</div>";
    }
    
    html += "<div class='section-title' style='margin-top: 1rem;'>Your Upcoming Lessons (" + myLessons.length + ")</div>";
    
    if(myLessons.length === 0) {
        html += "<p style='color: var(--stone-500);'>No upcoming lessons scheduled.</p>";
    } else {
        html += "<div class='scroll-container'>";
        myLessons.forEach(lesson => {
            html += "<div class='lesson-list-item' onclick='showStudentSwapOptions(" + lesson.id + ",\"" + firstName + "\",\"" + lastName + "\")'>" +
                "<div>" +
                "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                "<div class='lesson-list-duration'>" + lesson.duration + " min" + (lesson.isRecurring ? " • 🔁 Recurring" : "") + "</div>" +
                "</div>" +
                "<span style='color: var(--violet-500); font-weight: 600;'>→</span>" +
                "</div>";
        });
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function showStudentSwapOptions(lessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === lessonId);
    
    const availableLessons = lessons.filter(l => {
        if(l.id === lessonId) return false;
        if(l.firstName === myLesson.firstName && l.lastName === myLesson.lastName) return false;
        if(isInPast(l.week, l.day)) return false;
        if(l.week !== myLesson.week && !l.isRecurring) return false;
        return true;
    });
    
    if(availableLessons.length === 0) {
        modal("<h3 class='modal-title'>🔄 Request Swap</h3>" +
            "<p>No other lessons available to swap with at this time.</p>" +
            "<button onclick='showMyLessonsForSwap()' class='modal-btn modal-btn-secondary'>Back</button>");
        return;
    }
    
    let html = "<h3 class='modal-title'>🔄 Request Swap</h3>" +
        "<p class='modal-subtitle'>Your lesson: " + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</p>" +
        "<div class='section-title'>Select a lesson to swap with</div>" +
        "<div class='scroll-container'>";
    
    availableLessons.forEach(lesson => {
        const otherName = formatNamePrivate(lesson.firstName, lesson.lastName);
        html += "<div class='student-card' onclick='confirmStudentSwapRequest(" + lessonId + "," + lesson.id + ",\"" + firstName + "\",\"" + lastName + "\")'>" +
            "<div class='student-name-large'>" + otherName + "</div>" +
            "<div class='student-meta'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + " (" + lesson.duration + " min)" + (lesson.isRecurring ? " 🔁" : "") + "</div>" +
            "</div>";
    });
    
    html += "</div>" +
        "<button onclick='showMyLessonsForSwap()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Cancel</button>";
    
    modal(html);
}

function confirmStudentSwapRequest(myLessonId, theirLessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === myLessonId);
    const theirLesson = lessons.find(l => l.id === theirLessonId);
    const theirName = formatNamePrivate(theirLesson.firstName, theirLesson.lastName);
    
    const html = "<h3 class='modal-title'>🔄 Confirm Swap Request</h3>" +
        "<div class='profile-section'>" +
        "<div class='text-sm mb-2'><strong>You want to swap:</strong></div>" +
        "<div style='padding-left: 1rem; margin-bottom: 0.75rem;'>" +
        "<div class='text-sm'><strong>Your lesson</strong></div>" +
        "<div class='text-xs' style='color: var(--stone-600);'>" + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</div>" +
        "</div>" +
        "<div class='swap-arrow'>⬍</div>" +
        "<div style='padding-left: 1rem;'>" +
        "<div class='text-sm'><strong>" + theirName + "</strong></div>" +
        "<div class='text-xs' style='color: var(--stone-600);'>" + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</div>" +
        "</div>" +
        "</div>" +
        "<div class='info-box info-box-info'>" +
        "ℹ️ " + theirName + " will receive this request and can approve or decline." +
        "</div>" +
        "<button onclick='createStudentSwapRequest(" + myLessonId + "," + theirLessonId + ",\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-violet'>Send Request</button>" +
        "<button onclick='showStudentSwapOptions(" + myLessonId + ",\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Back</button>";
    
    modal(html);
}

function createStudentSwapRequest(myLessonId, theirLessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === myLessonId);
    const theirLesson = lessons.find(l => l.id === theirLessonId);
    
    const existing = swapRequests.find(r => 
        (r.requestingLessonId === myLessonId && r.targetLessonId === theirLessonId) ||
        (r.requestingLessonId === theirLessonId && r.targetLessonId === myLessonId)
    );
    
    if(existing && existing.status === 'pending') {
        toast("A swap request already exists");
        showMyLessonsForSwap();
        return;
    }
    
    swapRequests.push({
        id: nextSwapId++,
        requestingLessonId: myLessonId,
        targetLessonId: theirLessonId,
        requestingStudent: myLesson.firstName + " " + myLesson.lastName,
        targetStudent: theirLesson.firstName + " " + theirLesson.lastName,
        status: 'pending',
        timestamp: new Date().toISOString()
    });
    
    toast("Swap request sent!");
    render();
    closeModal();
}

function approveSwapInPortal(requestId, firstName, lastName) {
    const request = swapRequests.find(r => r.id === requestId);
    if(!request) return;
    
    // Mark as student agreed - teacher still needs to approve
    request.status = 'student_agreed';
    request.studentAgreedAt = new Date().toISOString();
    request.agreedBy = firstName + " " + lastName;
    
    // Mark as seen for the current user (they just took the action)
    const fullName = firstName + " " + lastName;
    if(!seenNotifications[fullName]) seenNotifications[fullName] = [];
    if(!seenNotifications[fullName].includes(requestId)) {
        seenNotifications[fullName].push(requestId);
    }
    
    toast("Swap accepted! Waiting for teacher approval.");
    saveData();
    render();
    showMyLessonsForSwap();
}

function declineSwapInPortal(requestId, firstName, lastName) {
    const request = swapRequests.find(r => r.id === requestId);
    if(request) {
        request.status = 'declined';
        request.resolvedAt = new Date().toISOString();
    }
    
    // Mark as seen for the current user (they just took the action)
    const fullName = firstName + " " + lastName;
    if(!seenNotifications[fullName]) seenNotifications[fullName] = [];
    if(!seenNotifications[fullName].includes(requestId)) {
        seenNotifications[fullName].push(requestId);
    }
    
    toast("Swap declined");
    showMyLessonsForSwap();
}

function createDefaultBlocks() {
    if(blockedTimes.length > 0) return;
    
    const nightHours = ["21:00", "22:00", "23:00", "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00"];
    const dayHours = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00"];
    
    // Block night hours for all days
    for(let day = 0; day < 7; day++) {
        nightHours.forEach(time => {
            for(let week = -2; week <= 52; week++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: day,
                    time: time,
                    duration: 60,
                    reason: "Closed",
                    week: week
                });
            }
        });
    }
    
    // Block daytime hours for weekends (Saturday = 5, Sunday = 6)
    [5, 6].forEach(day => {
        dayHours.forEach(time => {
            for(let week = -2; week <= 52; week++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: day,
                    time: time,
                    duration: 60,
                    reason: "Weekend",
                    week: week
                });
            }
        });
    });
}

createDefaultBlocks();

// ===== PAYMENT TRACKING FUNCTIONS =====
function showPaymentsModal() {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    // Calculate totals
    let totalOwed = 0;
    let totalPaid = 0;
    
    students.forEach(student => {
        const studentPayments = getStudentPaymentSummary(student.firstName, student.lastName);
        totalOwed += studentPayments.totalOwed;
        totalPaid += studentPayments.totalPaid;
    });
    
    const outstanding = totalOwed - totalPaid;
    
    let html = "<h3 class='modal-title'>💰 Payment Tracking</h3>" +
        "<p class='modal-subtitle'>Manage lesson payments and invoices</p>";
    
    // Summary stats
    html += "<div class='payment-summary'>" +
        "<div class='payment-stat total'>" +
        "<div class='payment-stat-value'>$" + totalOwed.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Total Billed</div>" +
        "</div>" +
        "<div class='payment-stat paid'>" +
        "<div class='payment-stat-value'>$" + totalPaid.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Received</div>" +
        "</div>" +
        "<div class='payment-stat unpaid'>" +
        "<div class='payment-stat-value'>$" + outstanding.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Outstanding</div>" +
        "</div>" +
        "</div>";
    
    // Quick actions
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='showRecordPaymentModal()' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>+ Record Payment</button>" +
        "<button onclick='showRatesModal()' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>⚙️ Rates</button>" +
        "</div>";
    
    // Student balances
    html += "<div class='section-title'>Student Balances</div>";
    html += "<div class='scroll-container'>";
    
    students.forEach(student => {
        const summary = getStudentPaymentSummary(student.firstName, student.lastName);
        const balance = summary.totalOwed - summary.totalPaid;
        const badgeClass = balance <= 0 ? 'paid' : 'unpaid';
        const badgeText = balance <= 0 ? 'PAID' : '$' + balance.toFixed(0) + ' DUE';
        
        html += "<div class='payment-row' onclick='showStudentPayments(\"" + student.firstName + "\",\"" + student.lastName + "\")'>" +
            "<div class='payment-row-info'>" +
            "<div class='payment-row-name'>" + student.firstName + " " + student.lastName + "</div>" +
            "<div class='payment-row-detail'>" + summary.lessonCount + " lessons • $" + summary.totalOwed.toFixed(0) + " billed</div>" +
            "</div>" +
            "<span class='payment-badge " + badgeClass + "'>" + badgeText + "</span>" +
            "</div>";
    });
    
    html += "</div>";
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function getStudentPaymentSummary(firstName, lastName) {
    const studentKey = firstName + " " + lastName;
    
    // Get all past lessons for this student (that should be paid for)
    const pastLessons = lessons.filter(l => 
        l.firstName === firstName && 
        l.lastName === lastName && 
        isInPast(l.week, l.day)
    );
    
    // Calculate total owed
    let totalOwed = 0;
    pastLessons.forEach(lesson => {
        totalOwed += lessonRates[lesson.duration] || lessonRates[60];
    });
    
    // Calculate total paid
    const studentPayments = payments.filter(p => p.studentKey === studentKey);
    const totalPaid = studentPayments.reduce((sum, p) => sum + p.amount, 0);
    
    return {
        lessonCount: pastLessons.length,
        totalOwed: totalOwed,
        totalPaid: totalPaid,
        balance: totalOwed - totalPaid
    };
}

function showStudentPayments(firstName, lastName) {
    const studentKey = firstName + " " + lastName;
    const summary = getStudentPaymentSummary(firstName, lastName);
    const studentPayments = payments.filter(p => p.studentKey === studentKey).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = "<h3 class='modal-title'>💰 " + firstName + " " + lastName + "</h3>";
    
    // Summary
    const balance = summary.totalOwed - summary.totalPaid;
    const statusClass = balance <= 0 ? 'paid' : 'unpaid';
    const statusText = balance <= 0 ? 'All Paid Up!' : '$' + balance.toFixed(0) + ' Outstanding';
    
    html += "<div class='payment-summary'>" +
        "<div class='payment-stat total'>" +
        "<div class='payment-stat-value'>$" + summary.totalOwed.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Total Billed</div>" +
        "</div>" +
        "<div class='payment-stat paid'>" +
        "<div class='payment-stat-value'>$" + summary.totalPaid.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Paid</div>" +
        "</div>" +
        "<div class='payment-stat " + statusClass + "'>" +
        "<div class='payment-stat-value'>" + (balance <= 0 ? '✓' : '$' + balance.toFixed(0)) + "</div>" +
        "<div class='payment-stat-label'>" + (balance <= 0 ? 'Paid Up' : 'Balance Due') + "</div>" +
        "</div>" +
        "</div>";
    
    // Quick actions
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='showRecordPaymentModal(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>+ Record Payment</button>" +
        "<button onclick='generateInvoice(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>📄 Invoice</button>" +
        "</div>";
    
    // Payment history
    html += "<div class='section-title'>Payment History</div>";
    
    if(studentPayments.length === 0) {
        html += "<p style='color: var(--stone-500); font-size: 0.875rem;'>No payments recorded yet.</p>";
    } else {
        html += "<div class='scroll-container'>";
        studentPayments.forEach(payment => {
            const date = new Date(payment.date);
            html += "<div class='payment-row'>" +
                "<div class='payment-row-info'>" +
                "<div class='payment-row-name'>$" + payment.amount.toFixed(2) + "</div>" +
                "<div class='payment-row-detail'>" + date.toLocaleDateString() + (payment.note ? ' • ' + payment.note : '') + "</div>" +
                "</div>" +
                "<button onclick='deletePayment(" + payment.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='background: var(--rose-500); color: white; font-size: 0.7rem;'>✕</button>" +
                "</div>";
        });
        html += "</div>";
    }
    
    html += "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Back</button>";
    
    modal(html);
}

function showRecordPaymentModal(firstName, lastName) {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    let studentOptions = "";
    if(!firstName) {
        studentOptions = "<option value=''>-- Select Student --</option>";
    }
    students.forEach(s => {
        const selected = (firstName === s.firstName && lastName === s.lastName) ? ' selected' : '';
        studentOptions += "<option value='" + s.firstName + "|" + s.lastName + "'" + selected + ">" + s.firstName + " " + s.lastName + "</option>";
    });
    
    const today = new Date().toISOString().split('T')[0];
    
    let html = "<h3 class='modal-title'>💵 Record Payment</h3>";
    
    html += "<label class='form-label'>Student</label>" +
        "<select id='paymentStudent' class='form-select' onchange='updatePaymentSuggestion()'>" + studentOptions + "</select>" +
        "<label class='form-label'>Amount</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='paymentAmount' class='form-input' placeholder='0.00' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<div id='paymentSuggestion' style='font-size: 0.75rem; color: var(--stone-500); margin-top: 0.25rem;'></div>" +
        "<label class='form-label'>Date</label>" +
        "<input type='date' id='paymentDate' class='form-input' value='" + today + "'>" +
        "<label class='form-label'>Note <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='paymentNote' class='form-input' placeholder='e.g., Check #1234, Venmo, Cash'>" +
        "<button onclick='savePayment()' class='modal-btn modal-btn-success'>Save Payment</button>" +
        "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
    
    if(firstName) {
        setTimeout(updatePaymentSuggestion, 100);
    }
}

function updatePaymentSuggestion() {
    const select = document.getElementById('paymentStudent');
    const suggestion = document.getElementById('paymentSuggestion');
    const amountInput = document.getElementById('paymentAmount');
    
    if(!select.value) {
        suggestion.textContent = '';
        return;
    }
    
    const parts = select.value.split('|');
    const summary = getStudentPaymentSummary(parts[0], parts[1]);
    const balance = summary.totalOwed - summary.totalPaid;
    
    if(balance > 0) {
        suggestion.innerHTML = 'Balance due: <strong>$' + balance.toFixed(2) + '</strong> • <a href="#" onclick="document.getElementById(\'paymentAmount\').value=' + balance.toFixed(2) + ';return false;">Use this amount</a>';
    } else {
        suggestion.textContent = 'All paid up! Balance: $0.00';
    }
}

function savePayment() {
    const select = document.getElementById('paymentStudent');
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const date = document.getElementById('paymentDate').value;
    const note = document.getElementById('paymentNote').value.trim();
    
    if(!select.value) {
        toast('Please select a student');
        return;
    }
    
    if(!amount || amount <= 0) {
        toast('Please enter a valid amount');
        return;
    }
    
    const parts = select.value.split('|');
    
    payments.push({
        id: nextPaymentId++,
        studentKey: parts[0] + ' ' + parts[1],
        amount: amount,
        date: date,
        note: note,
        createdAt: new Date().toISOString()
    });
    
    toast('Payment recorded: $' + amount.toFixed(2));
    saveData();
    showStudentPayments(parts[0], parts[1]);
}

function deletePayment(paymentId, firstName, lastName) {
    if(confirm('Delete this payment record?')) {
        payments = payments.filter(p => p.id !== paymentId);
        toast('Payment deleted');
        saveData();
        showStudentPayments(firstName, lastName);
    }
}

function showRatesModal() {
    let html = "<h3 class='modal-title'>⚙️ Lesson Rates</h3>" +
        "<p class='modal-subtitle'>Set your rates by lesson duration</p>";
    
    html += "<label class='form-label'>30-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate30' class='form-input' value='" + lessonRates[30] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<label class='form-label'>45-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate45' class='form-input' value='" + lessonRates[45] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<label class='form-label'>60-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate60' class='form-input' value='" + lessonRates[60] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<button onclick='saveRates()' class='modal-btn modal-btn-primary'>Save Rates</button>" +
        "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveRates() {
    lessonRates[30] = parseFloat(document.getElementById('rate30').value) || 40;
    lessonRates[45] = parseFloat(document.getElementById('rate45').value) || 55;
    lessonRates[60] = parseFloat(document.getElementById('rate60').value) || 70;
    
    toast('Rates updated!');
    saveData();
    showPaymentsModal();
}

function generateInvoice(firstName, lastName) {
    const studentKey = firstName + ' ' + lastName;
    const summary = getStudentPaymentSummary(firstName, lastName);
    
    // Get unpaid lessons (past lessons)
    const pastLessons = lessons.filter(l => 
        l.firstName === firstName && 
        l.lastName === lastName && 
        isInPast(l.week, l.day)
    ).sort((a, b) => {
        const dateA = getActualDate(a.week, a.day);
        const dateB = getActualDate(b.week, b.day);
        return dateA - dateB;
    });
    
    // Get recent ones (last 4 weeks)
    const recentLessons = pastLessons.slice(-8);
    
    const profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    const guardianName = profile ? profile.guardianName : 'Parent/Guardian';
    const today = new Date();
    
    let html = "<h3 class='modal-title'>📄 Invoice</h3>";
    
    html += "<div class='invoice-preview'>" +
        "<div class='invoice-header'>" +
        "<div>" +
        "<div class='invoice-title'>🐦 Loonie Bird Music</div>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500);'>Music Lessons Invoice</div>" +
        "</div>" +
        "<div style='text-align: right;'>" +
        "<div style='font-weight: 600;'>Invoice Date</div>" +
        "<div style='font-size: 0.85rem;'>" + today.toLocaleDateString() + "</div>" +
        "</div>" +
        "</div>" +
        "<div style='margin-bottom: 1rem;'>" +
        "<div style='font-weight: 600;'>Bill To:</div>" +
        "<div>" + guardianName + "</div>" +
        "<div style='color: var(--stone-500);'>Student: " + firstName + " " + lastName + "</div>" +
        "</div>" +
        "<table class='invoice-table'>" +
        "<thead><tr><th>Date</th><th>Duration</th><th>Amount</th></tr></thead>" +
        "<tbody>";
    
    let invoiceTotal = 0;
    recentLessons.forEach(lesson => {
        const date = getActualDate(lesson.week, lesson.day);
        const rate = lessonRates[lesson.duration] || lessonRates[60];
        invoiceTotal += rate;
        html += "<tr>" +
            "<td>" + date.toLocaleDateString() + "</td>" +
            "<td>" + lesson.duration + " min</td>" +
            "<td>$" + rate.toFixed(2) + "</td>" +
            "</tr>";
    });
    
    html += "</tbody></table>" +
        "<div class='invoice-total'>" +
        "Total: $" + invoiceTotal.toFixed(2) +
        "</div>";
    
    if(summary.totalPaid > 0) {
        html += "<div style='text-align: right; font-size: 0.85rem; color: var(--stone-500);'>" +
            "Payments received: $" + summary.totalPaid.toFixed(2) + "<br>" +
            "Balance due: $" + Math.max(0, summary.totalOwed - summary.totalPaid).toFixed(2) +
            "</div>";
    }
    
    html += "</div>";
    
    html += "<button onclick='printInvoice()' class='modal-btn modal-btn-primary'>🖨️ Print Invoice</button>" +
        "<button onclick='showStudentPayments(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Back</button>";
    
    modal(html);
}

function printInvoice() {
    const invoiceContent = document.querySelector('.invoice-preview');
    if(invoiceContent) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Invoice</title>');
        printWindow.document.write('<style>body{font-family:system-ui,sans-serif;padding:2rem;} table{width:100%;border-collapse:collapse;margin:1rem 0;} th,td{padding:0.5rem;text-align:left;border-bottom:1px solid #ddd;} th{background:#f5f5f4;} .invoice-title{font-size:1.5rem;font-weight:bold;} .invoice-header{display:flex;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid #ddd;} .invoice-total{text-align:right;font-size:1.25rem;font-weight:bold;margin-top:1rem;padding-top:1rem;border-top:2px solid #333;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(invoiceContent.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }
}

console.log("Loonie Bird loaded successfully!");

// Hide splash screen after load
window.addEventListener('load', function() {
    setTimeout(function() {
        const splash = document.getElementById('splashScreen');
        if(splash) {
            splash.classList.add('hidden');
            // Remove from DOM after animation
            setTimeout(function() {
                splash.remove();
            }, 400);
        }
    }, 500); // Brief delay to show splash
});
</script>
</body>
</html>
